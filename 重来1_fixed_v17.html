<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HSK单词游戏 · HSK Word Game (Fixed v5)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2b;
      --neon1:#7afcff;
      --neon2:#b693ff;
      --neon3:#5cff9d;
      --btnDepth: 14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1000px 500px at 10% -20%, rgba(122,252,255,.12), transparent 60%),
                  radial-gradient(800px 400px at 90% 0%, rgba(182,147,255,.12), transparent 55%),
                  linear-gradient(180deg, #0b1220 0%, #0a0f1c 100%);
      color:#e9f1ff; overflow-x:hidden;
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px 16px 56px; }

    .hero{ position:relative; border-radius:18px; padding:32px 20px; margin-top:8px; margin-bottom:18px;
      background: linear-gradient(145deg, rgba(17,26,43,.92), rgba(15,23,39,.75));
      box-shadow: inset 0 0 0 1px rgba(122,252,255,.08), 0 30px 80px rgba(0,0,0,.45); overflow:hidden; }
    .hero::before{ content:""; position:absolute; inset:-2px; border-radius:20px;
      background: conic-gradient(from 210deg, rgba(122,252,255,.15), rgba(182,147,255,.18), rgba(92,255,157,.15), rgba(122,252,255,.15));
      filter: blur(26px); opacity:.55; pointer-events:none; mask: radial-gradient(120% 120% at 50% 0%, black 40%, transparent 55%); }
    .title-cn,.title-en{ text-align:center; margin:0; letter-spacing:2px; }
    .title-cn{ font-size:42px; font-weight:800; }
    .title-en{ font-size:28px; font-weight:700; opacity:.92; }
    .glowtext{ background: linear-gradient(90deg, #e9f1ff, #8ee7ff, #c4b5ff, #9bffcc, #e9f1ff); background-size:200% 100%;
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: hueMove 10s linear infinite, shimmer 3.6s ease-in-out infinite; text-shadow: 0 0 12px rgba(122,252,255,.15), 0 0 22px rgba(182,147,255,.12); }
    @keyframes hueMove{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
    @keyframes shimmer{ 0%,100%{filter:drop-shadow(0 0 0 rgba(0,0,0,0))} 50%{filter:drop-shadow(0 0 14px rgba(122,252,255,.35))} }

    .top-actions{ display:flex; gap:12px; align-items:center; padding:12px 4px 0; }
    .top-actions .spacer{ flex:1; }

    .btn{ --c1:var(--neon1); --c2:var(--neon2); position:relative; border:none; outline:none; cursor:pointer; user-select:none; font-weight:700; font-size:14px; letter-spacing:.3px; color:#0b1220; padding:12px 18px; border-radius:12px;
      background: linear-gradient(180deg, white, #dfe8ff);
      box-shadow: 0 var(--btnDepth) 0 rgba(0,0,0,.35), 0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.7), 0 0 0 1px rgba(122,252,255,.25), 0 0 24px rgba(182,147,255,.25);
      transition: transform .15s ease, box-shadow .15s ease;
      background-image: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,244,255,.95)), radial-gradient(120% 140% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(120% 140% at 110% 120%, var(--c2) 0%, transparent 45%);
    }
    .btn:hover{ transform:translateY(-3px); box-shadow: 0 calc(var(--btnDepth)+3px) 0 rgba(0,0,0,.36), 0 18px 36px rgba(0,0,0,.45), 0 0 36px rgba(122,252,255,.35); }
    .btn:active{ transform:translateY(2px); box-shadow: 0 calc(var(--btnDepth)-2px) 0 rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.35); }

    .sound-wrap{ display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:14px; background: rgba(255,255,255,.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .switch{ position:relative; width:54px; height:28px; background:#2a3652; border-radius:999px; cursor:pointer; box-shadow: inset 0 0 0 1px rgba(122,252,255,.2); }
    .switch::after{ content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background: linear-gradient(180deg, #fff, #e6eeff); box-shadow: 0 6px 12px rgba(0,0,0,.45); transition: left .2s ease; }
    .switch.on{ background: linear-gradient(90deg, rgba(122,252,255,.45), rgba(182,147,255,.45)); }
    .switch.on::after{ left:29px; }
    .volume{ accent-color:#7afcff; height:28px; }
    .label{ font-size:13px; opacity:.92; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:22px; margin-top:18px; }
    .grid .span2{ grid-column: span 2; }

    .card{ position:relative; border-radius:18px; padding:26px 24px; text-align:center; overflow:hidden; cursor:pointer; user-select:none; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 18px 60px rgba(0,0,0,.45); transition: transform .18s ease, box-shadow .18s ease, filter .18s ease; }
    .card:hover{ transform: translateY(-6px); filter:saturate(1.12); box-shadow: inset 0 0 0 1px rgba(122,252,255,.2), 0 24px 80px rgba(0,0,0,.55), 0 0 48px rgba(122,252,255,.28); }
    .card::before{ content:""; position:absolute; inset:0; background: radial-gradient(220px 120px at var(--mx,50%) var(--my,50%), rgba(122,252,255,.18), transparent 55%); pointer-events:none; transition: background .15s ease; }

    .cn{ font-size:26px; font-weight:800; margin-bottom:8px; text-shadow: 0 2px 0 rgba(0,0,0,.3), 0 0 18px rgba(122,252,255,.2); }
    .en{ font-size:16px; font-weight:700; opacity:.95; }

    .red{ background: linear-gradient(180deg, rgba(255,103,103,.15), rgba(255,103,103,.05)); }
    .green{ background: linear-gradient(180deg, rgba(76,252,169,.15), rgba(76,252,169,.05)); }
    .blue{ background: linear-gradient(180deg, rgba(91,157,255,.18), rgba(91,157,255,.06)); }
    .amber{ background: linear-gradient(180deg, rgba(255,199,95,.18), rgba(255,199,95,.06)); }
    .purple{ background: linear-gradient(180deg, rgba(208,143,255,.18), rgba(208,143,255,.06)); }
    .teal{ background: linear-gradient(180deg, rgba(86,236,255,.16), rgba(86,236,255,.06)); }

    .stage{ display:none; margin-top:18px; border-radius:20px; padding:28px 18px 34px; background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(235,243,255,.92)); color:#0e1422; box-shadow: inset 0 0 0 1px rgba(10,20,40,.08), 0 24px 80px rgba(0,0,0,.35); }
    .stage-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .module-title{ font-weight:900; font-size:28px; letter-spacing:.5px; background: linear-gradient(90deg, #1d2140, #193a59, #1d2140); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:none; }
    .subtitle{ font-size:14px; opacity:.7; }

    .stage-actions{ display:grid; grid-template-columns: repeat(2, 1fr); gap:22px; }
    
    .action-btn{ --c1:#00d4ff; --c2:#0077ff; color:#0a1020; font-weight:900; font-size:18px; padding:24px 18px; border-radius:18px; border:none; cursor:pointer; user-select:none; box-shadow: 0 14px 0 rgba(0,0,0,.25), 0 22px 54px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.7); background-image: linear-gradient(180deg, rgba(255,255,255,.94), rgba(242,248,255,.99)), radial-gradient(140% 160% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(140% 160% at 110% 120%, var(--c2) 0%, transparent 45%); transition: transform .15s ease, box-shadow .15s ease; }
    .action-btn:hover{ transform: translateY(-4px); box-shadow: 0 16px 0 rgba(0,0,0,.26), 0 26px 64px rgba(0,0,0,.35); }
    .action-btn:active{ transform: translateY(2px); box-shadow: 0 9px 0 rgba(0,0,0,.3), 0 18px 36px rgba(0,0,0,.32); }
    .act-demo{ --c1:#7afcff; --c2:#8ec5ff; }
    .act-import{ --c1:#ffd37a; --c2:#ffb36b; }

    .game{ position:relative; display:none; margin-top:18px; border-radius:22px; background: linear-gradient(180deg, #f9fbff, #edf4ff); color:#0f1430; box-shadow: inset 0 0 0 1px rgba(12,22,44,.08), 0 24px 80px rgba(0,0,0,.35); }
    .game-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px 8px; border-bottom:1px dashed rgba(12,22,44,.12); }
    .game-left{ font-weight:900; font-size:18px; }
    .progress{ font-weight:800; font-size:14px; opacity:.85; }

    .lang-row{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px; }
    .lang-btn{ border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:800; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); transition:.15s; }
    .lang-btn.active{ outline:2px solid #0ea5e9; box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 22px 48px rgba(0,0,0,.22); }

    .jump{ display:flex; align-items:center; gap:8px; }
    .jump input{ width:86px; padding:8px 10px; border-radius:10px; border:1px solid rgba(12,22,44,.18); }

    .board{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; padding:18px; }
    .col{ display:grid; grid-template-rows: repeat(5, 64px); gap:12px; padding:12px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,245,255,.95)); box-shadow: inset 0 0 0 1px rgba(12,22,44,.08); }
    .col-cn{ --tileC:#ffb36b; }
    .col-py{ --tileC:#7de67f; }
    .col-tr{ --tileC:#7fb3ff; }

    .tile{ display:flex; align-items:center; justify-content:center; text-align:center; padding:10px; border-radius:12px; cursor:pointer; user-select:none; font-weight:900; color:#0b1220; background: linear-gradient(180deg, #fff, #eaf2ff); box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 18px 44px rgba(0,0,0,.22), inset 0 0 0 2px rgba(255,255,255,.9), 0 0 0 1px rgba(0,0,0,.04); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .3s ease; border:2px solid rgba(0,0,0,.06); position:relative; }
    .tile::after{ content:""; position:absolute; inset:0; border-radius:12px; box-shadow: inset 0 0 48px rgba( 0, 0, 0, .12 ); opacity:.9; }
    .tile:hover{ transform: translateY(-3px); box-shadow: 0 14px 0 rgba(0,0,0,.2), 0 28px 56px rgba(0,0,0,.26); }
    .tile.selected{ outline:3px solid var(--tileC); filter: saturate(1.15); }
    .tile.correct{ animation: flashOut .6s ease forwards; }
    .tile.wrong{ animation: shake .25s ease; }

    @keyframes flashOut{ 0%{ opacity:1; filter:brightness(1); } 50%{ opacity:.35; filter:brightness(1.6); } 100%{ opacity:0; transform: scale(.96); } }
    @keyframes shake{ 0%,100%{ transform:translateX(0); } 25%{ transform:translateX(-4px); } 75%{ transform:translateX(4px); } }

    .game-bottom{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px 20px; border-top:1px dashed rgba(12,22,44,.12); }
    .mini-btn{ border:none; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); }

    .finish-overlay{ display:none; position:absolute; inset:0; backdrop-filter: blur(4px); background: rgba(255,255,255,.6); align-items:center; justify-content:center; gap:14px; padding:16px; text-align:center; }
    .finish-overlay .btn{ font-size:16px; }

    .wrongpad{ position:fixed; right:18px; bottom:18px; width:360px; max-height:60vh; overflow:auto; background:rgba(255,255,255,.92); border-radius:16px; box-shadow: 0 18px 54px rgba(0,0,0,.35); display:none; padding:16px; backdrop-filter: blur(6px); }
    .wrongpad h4{ margin:0 0 10px; color:#0e1422; font-weight:900; }
    .wrongpad .witem{ font-size:14px; padding:10px 12px; border-radius:12px; background:linear-gradient(180deg,#f2f7ff,#eaf1ff); color:#0b1220; box-shadow: inset 0 0 0 1px rgba(12,22,44,.09), 0 8px 22px rgba(0,0,0,.08); margin-bottom:10px; }

    @media (max-width: 900px){
      .stage-actions{ grid-template-columns: 1fr; }
      .board{ grid-template-columns: 1fr; }
      .col{ grid-template-rows: repeat(5, 58px); }
    }

    footer{ margin-top:28px; font-size:12px; opacity:.8; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <section class="hero" id="hero">
      <h1 class="title-cn glowtext">HSK单词游戏</h1>
      <h2 class="title-en glowtext">HSK Word Game</h2>
      <div class="top-actions">
        <div class="spacer"></div>
        <button class="btn" id="btnRegister" aria-haspopup="dialog">注册 Register</button>
        <button class="btn" id="btnLogin" aria-haspopup="dialog">登录 Login</button>
        <div class="sound-wrap" title="音效与音量">
          <span class="label">音效 Sound</span>
          <div id="soundSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          <input id="volume" class="volume" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="音量 Volume" />
        </div>
      </div>
    </section>

    <section class="grid" id="menu">
      <div class="card red" data-key="dev-cn">
        <div class="cn">发展汉语词汇</div>
        <div class="en">Developing Chinese Vocabulary</div>
      </div>
      <div class="card green" data-key="hsk">
        <div class="cn">HSK词汇</div>
        <div class="en">HSK Vocabulary</div>
      </div>
      <div class="card blue" data-key="fill">
        <div class="cn">选词填空</div>
        <div class="en">Fill in the Blanks</div>
      </div>
      <div class="card amber" data-key="build">
        <div class="cn">词语组句</div>
        <div class="en">Sentence Building</div>
      </div>
      <div class="card purple" data-key="order">
        <div class="cn">句子排序</div>
        <div class="en">Sentence Ordering</div>
      </div>
      <div class="card teal" data-key="banks">
        <div class="cn">获取词库和题库</div>
        <div class="en">Get Word & Question Banks</div>
      </div>
    </section>

    <section class="game" id="gameDemo" aria-hidden="true">
      <div class="game-top">
        <div class="game-left">
          <span id="levelInfo">关卡：<strong>1</strong></span>
          &nbsp;|&nbsp;
          <span class="progress">进度 <span id="passed">0</span>/<span id="total">0</span></span>
        </div>
        <div class="jump">
          <label>跳往第 <input type="number" id="jumpInput" min="1" value="1" /> 关</label>
          <button class="btn" id="jumpGo">Go</button>
        </div>
      </div>
      <div class="lang-row" id="langRow"></div>
      <div class="board" id="board">
        <div class="col col-cn" id="colCN" aria-label="中文列"></div>
        <div class="col col-py" id="colPY" aria-label="拼音列"></div>
        <div class="col col-tr" id="colTR" aria-label="翻译列"></div>
      </div>
      <div class="game-bottom">
        <button class="mini-btn" id="btnTip">提示 / Tips</button>
        <button class="mini-btn" id="btnShuffle">重排序 / Reshuffle</button>
        <button class="mini-btn" id="btnSave">保存 / Save</button>
        <button class="mini-btn" id="btnBack">返回上一级 / Back</button>
        <button class="mini-btn" id="btnWrong">错词本 / Wrong Book</button>
      </div>
      <div class="finish-overlay" id="finish">
        <div id="finishText" style="font-weight:800; margin-bottom:8px;">本关完成！</div>
        <div>
          <button class="btn" id="btnPrev">返回上一关</button>
          <button class="btn" id="btnNext">继续下一关</button>
        </div>
      </div>
    </section>

    <section class="stage" id="stage">
      <div class="stage-header">
        <div>
          <div class="module-title" id="modTitle">模块标题</div>
          <div class="subtitle" id="modSub">Module Subtitle</div>
        </div>
        <button class="btn" id="btnBackTop">返回主菜单 / Back</button>
      </div>
      <div class="stage-actions">
        <button class="action-btn act-demo" id="actDemo">试玩游戏<br><small>Demo (Built-in 20)</small></button>
        <button class="action-btn act-import" id="actImport">导入词库玩游戏<br><small>Import & Play</small></button>
        <input id="fileImport" type="file" accept=".csv,.txt" style="display:none" />
        <button class="action-btn" id="btnClearTrial" style="display:none; --c1:#ff9aa2; --c2:#ff6f91;">清除导入词库<br><small>Clear Imported Bank</small></button>
      </div>
    </section>

    <footer>
      Copyright Held by: Mr. Yan Qinghua, Chongqing Technology and Business University (CTBU)<br/>
      Support by: Teaching and Research Section of TCFL, CTBU
    </footer>
  </div>

  <dialog id="dlgRegister">
    <form method="dialog" id="formRegister" style="min-width:300px">
      <h3>注册 Register</h3>
      <label>用户名 Username<br/>
        <input id="regName" required maxlength="24" />
      </label><br/><br/>
      <label>密码 Password<br/>
        <input id="regPass" type="password" required minlength="4" />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">取消 Cancel</button>
        <button class="btn" value="default">提交 Submit</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgLogin">
    <form method="dialog" id="formLogin" style="min-width:300px">
      <h3>登录 Login</h3>
      <label>用户名 Username<br/>
        <input id="logName" required />
      </label><br/><br/>
      <label>密码 Password<br/>
        <input id="logPass" type="password" required />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">取消 Cancel</button>
        <button class="btn" value="default">登录 Login</button>
      </menu>
    </form>
  </dialog>

  <div class="wrongpad" id="wrongPad">
    <h4>错词本 Wrong Book</h4>
    <div id="wrongList"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button class="mini-btn" id="wrongClose">关闭 / Close</button>
      <button class="mini-btn" id="wrongClear">清空 / Clear</button>
    </div>
  </div>

  <div id="toastStack"></div>
    /* Shim */
    (function(){
      if(typeof window.Intercom!=="function"){
        const q=[]; const shim=function(){ q.push(arguments); };
        shim.q=q; shim.boot=function(){}; shim.shutdown=shim.show=shim.hide=shim.update=function(){};
        window.Intercom=shim;
      }
      window.notifyNavigation = window.notifyNavigation || function(){};
      window.notifyIntrinsicHeight = window.notifyIntrinsicHeight || function(){};
      window.__hostApi = window.__hostApi || {};
      ["notifyNavigation","notifyIntrinsicHeight"].forEach(k=>{
        if(typeof window.__hostApi[k]!=="function") window.__hostApi[k]=function(){};
      });
      window.addEventListener("unhandledrejection", function(e){
        const msg = (e && e.reason && (e.reason.stack||e.reason.message||e.reason)) || "";
        if(String(msg).match(/Intercom|Host API|notifyNavigation|notifyIntrinsicHeight/)) e.preventDefault();
      });
    })();

    const $ = (q)=>document.querySelector(q);

    /* ===== Users & Trial store ===== */
    const store = {
      get users(){ return JSON.parse(localStorage.getItem('hsk_users')||'{}'); },
      set users(v){ localStorage.setItem('hsk_users', JSON.stringify(v)); },
      get session(){ return JSON.parse(localStorage.getItem('hsk_session')||'null'); },
      set session(v){ localStorage.setItem('hsk_session', JSON.stringify(v)); },
      get trial(){ return JSON.parse(localStorage.getItem('dev_trial_words')||'null'); },
      set trial(v){ localStorage.setItem('dev_trial_words', JSON.stringify(v)); }
    };

    const btnRegister = $('#btnRegister');
    const btnLogin = $('#btnLogin');
    const dlgRegister = $('#dlgRegister');
    const dlgLogin = $('#dlgLogin');

    function safeShowModal(d){
      if(!d.open){ try{ d.showModal(); }catch{ d.setAttribute('open',''); } }
    }
    function safeClose(d){
      if(d.open){ try{ d.close(); }catch{ d.removeAttribute('open'); } }
    }

    function refreshAuthUI(){
      const s = store.session;
      if(s && s.username){
        btnRegister.textContent = '👋 欢迎 ' + s.username;
        btnRegister.disabled = true;
        btnLogin.textContent = '退出 Logout';
      }else{
        btnRegister.textContent = '注册 Register';
        btnRegister.disabled = false;
        btnLogin.textContent = '登录 Login';
      }
    }

    btnRegister.addEventListener('click', ()=>{ if(!store.session) safeShowModal(dlgRegister); });
    btnLogin.addEventListener('click', ()=>{
      if(store.session){ store.session = null; refreshAuthUI(); showToast('已退出 / Logged out','success'); return; }
      safeShowModal(dlgLogin);
    });

    document.getElementById('formRegister').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#regName').value.trim();
      const pass = $('#regPass').value;
      if(!name || !pass) return;
      const users = store.users;
      if(users[name]){ showToast('用户名已存在 / Username exists','error'); return; }
      users[name] = { password: pass };
      store.users = users;
      store.session = { username: name };
      safeClose(dlgRegister); refreshAuthUI();
      showToast('注册成功，已自动登录 / Registered & Signed in','success');
    });

    document.getElementById('formLogin').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#logName').value.trim();
      const pass = $('#logPass').value;
      const users = store.users;
      if(!users[name] || users[name].password !== pass){ showToast('用户或密码错误 / Invalid credentials','error'); return; }
      store.session = { username: name };
      safeClose(dlgLogin); refreshAuthUI();
      showToast('登录成功 / Signed in','success');
    });

    refreshAuthUI();

    /* ===== Audio ===== */
    const soundSwitch = document.getElementById('soundSwitch');
    const volume = document.getElementById('volume');
    let audioCtx, masterGain, isOn = true;

    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volume.value || 0.6);
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function applySwitchUI(){ soundSwitch.classList.toggle('on', isOn); soundSwitch.setAttribute('aria-checked', String(isOn)); }
    function toggleSound(){ isOn = !isOn; applySwitchUI(); }
    applySwitchUI();

    soundSwitch.addEventListener('click', ()=>{ ensureAudio(); toggleSound(); });
    soundSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); ensureAudio(); toggleSound(); } });
    volume.addEventListener('input', ()=>{ ensureAudio(); if(masterGain) masterGain.gain.value = Number(volume.value||0.6); });

    function playSfx(type='click'){
      if(!isOn) return;
      ensureAudio();
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = (type==='err') ? 'square' : 'sine';
      const cfg = {
        click: { f: 660, dur: 0.08 },
        ok:    { f: 880, dur: 0.14 },
        err:   { f: 180, dur: 0.18 },
        done:  { f: 520, dur: 0.24 },
        shuffle:{ f: 740, dur: 0.10 }
      }[type] || { f: 660, dur: 0.08 };
      osc.frequency.setValueAtTime(cfg.f, now);
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + cfg.dur);
      osc.connect(gain).connect(masterGain);
      osc.start(now);
      osc.stop(now + cfg.dur + 0.02);
    }

    /* ===== Module Nav ===== */
    const menu = document.getElementById('menu');
    const stage = document.getElementById('stage');
    const modTitle = document.getElementById('modTitle');
    const modSub = document.getElementById('modSub');
    const btnBackTop = document.getElementById('btnBackTop');
    const actDemo = document.getElementById('actDemo');
    const actImport = document.getElementById('actImport');
    const fileImport = document.getElementById('fileImport');
    const btnClearTrial = document.getElementById('btnClearTrial');

    function openModule(key, titleCN, titleEN){
      modTitle.textContent = titleCN;
      modSub.textContent = titleEN;
      menu.style.display = 'none';
      stage.style.display = 'block';
      showToast('进入模块：' + titleCN, 'success');
      stage.dataset.key = key;
      btnClearTrial.style.display = store.trial ? 'inline-block':'none';
    }
    function backHome(){ stage.style.display='none'; menu.style.display='grid'; }

    document.querySelectorAll('#menu .card').forEach(c=>{
      c.addEventListener('mousemove',(e)=>{
        const r = c.getBoundingClientRect();
        const x = ((e.clientX - r.left)/r.width)*100;
        const y = ((e.clientY - r.top)/r.height)*100;
        c.style.setProperty('--mx', x+'%');
        c.style.setProperty('--my', y+'%');
      });
      c.addEventListener('click', ()=>{
        const key = c.getAttribute('data-key');
        if(key==='banks'){ showToast('“获取词库和题库”页面稍后提供 / Coming soon','info'); return; }
        if(!store.session){ showToast('以游客模式进入。可在右上角注册/登录以保存进度。','info'); }
        const cn = c.querySelector('.cn').textContent.trim();
        const en = c.querySelector('.en').textContent.trim();
        playSfx('click'); openModule(key, cn, en);
      });
    });

    btnBackTop.addEventListener('click', backHome);

    actDemo.addEventListener('click', ()=>{
      playSfx('click');
      const key = stage.dataset.key;
      if(key === 'dev-cn'){
        stage.style.display='none';
        document.getElementById('gameDemo').style.display='block';
        initDemo(false); // built-in only
        showToast('发展英语·试玩（内置 20 个词）开始','success');
      }else{
        showToast('【'+modTitle.textContent+'】试玩模式启动（占位）/ Demo starting…','success');
      }
    });

    actImport.addEventListener('click', ()=>{
      playSfx('click'); fileImport.click();
    });

    fileImport.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = parseTrial(text);
        if(!parsed || !parsed.length){
          showToast('导入失败：未解析到有效条目。','error'); return;
        }
        const uniq = [];
        const seen = new Set();
        for(const w of parsed){
          const k = (w.cn||'') + '|' + (w.py||'');
          if(!seen.has(k)){ seen.add(k); uniq.push(w); }
          if(uniq.length>=20) break;
        }
        if(uniq.length<5){
          showToast('导入条目太少，至少需要 5 条。','error'); return;
        }
        store.trial = uniq;
        btnClearTrial.style.display = 'inline-block';
        showToast('成功导入 ${uniq.length} 条。该词库将用于“导入词库玩游戏”模式。','success');
      }catch(err){
        console.error(err);
        showToast('导入出错：文件读取或解析失败。','error');
      }finally{
        fileImport.value = '';
      }
    });

    btnClearTrial.addEventListener('click', ()=>{
      store.trial = null;
      btnClearTrial.style.display = 'none';
      showToast('已清除导入词库。','success');
    });

    /* ===== Toast ===== */
    function showToast(msg, type='info'){
      const stack = document.getElementById('toastStack') || (()=>{ const d=document.createElement('div'); d.id='toastStack'; Object.assign(d.style,{position:'fixed',left:'50%',top:'16px',transform:'translateX(-50%)',display:'flex',flexDirection:'column',gap:'8px',zIndex:9999}); document.body.appendChild(d); return d; })();
      const el = document.createElement('div'); el.className = 'toast ' + type; el.textContent = msg;
      Object.assign(el.style,{padding:'10px 14px',borderRadius:'10px',background:'#0b1220',color:'#e9f1ff',boxShadow:'0 8px 24px rgba(0,0,0,.35)',opacity:'0.98',transition:'all .4s ease'});
      stack.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 3200);
      setTimeout(()=>{ el.remove(); }, 3800);
    }

    /* ===== Built-in Demo Data (your uploaded 20 words) ===== */
    const DEMO_TXT = '你,nǐ,you (singular),คุณ,bạn,ເຈົ້າ,tu/vous,あなた,너/당신,ты,du,tú
好,hǎo,good/fine/nice,ดี,tốt,ດີ,bon,いい,좋은,хороший,gut,bueno
你们,nǐ men,you (plural),พวกคุณ,các bạn,ພວກເຈົ້າ,vous,あなたたち,너희/당신들,вы,ihr,vosotros/ustedes
老师,lǎo shī,teacher,ครู,giáo viên,ຄູ,professeur/enseignant,先生,선생님,учитель,Lehrer,profesor/maestro
早上,zǎo shang,morning/early morning,ตอนเช้า,buổi sáng,ຕອນເຊົ້າ,matin,朝,아침,утро,Morgen,mañana
是,shì,be,คือ,là,ແມ່ນ,être,です,이다,быть,sein,ser/estar
国,guó,country/state/nation,ประเทศ/ชาติ,quốc gia,ປະເທດ,pays/état/nation,国,나라/국가,страна/государство,Land/Staat/Nation,país/estado/nación
人,rén,people/human being,คน,người,ຄົນ,personne/humain,人,사람,человек/люди,Mensch/Person,persona/humano
我,wǒ,I/me,ฉัน,tôi,ຂ້ອຍ,je/moi,私,나/저,я,ich,yo
他,tā,he/him,เขา,anh ấy,ລາວ,il/lui,彼,그,он,er,él
请问,qǐng wèn,excuse me/may I ask,ขอถาม,xin hỏi,ຂໍຖາມ,excusez-moi/puis-je demander,すみません,실례합니다/여쭤보겠습니다,извините/могу я спросить,entschuldigen Sie/darf ich fragen,disculpe/¿puedo preguntar?
什么,shén me,what,อะไร,gì,ຫຍັງ,quoi/que,何,무엇/뭐,что,was,qué
名字,míng zi,name/given or personal name,ชื่อ,tên,ຊື່,nom,名前,이름,имя,Name,nombre
姓,xìng,be surnamed,นามสกุล,họ,ຊື່ສະກຸນ,nom de famille,苗字/姓,성,фамилия,Nachname,apellido
高兴,gāo xìng,glad/happy,ดีใจ,vui mừng,ດີໃຈ,content/heureux,嬉しい,기쁜,рад/счастливый,froh/glücklich,contento/feliz
大学生,dà xué shēng,college or university student,นักศึกษา,sinh viên đại học,ນັກສຶກສາມະຫາວິທະຍາໄລ,étudiant universitaire,大学生,대학생,студент университета,Universitätsstudent,estudiante universitario
几,jǐ,how many,กี่,mấy,ກີ່,combien,いくつ,몇,сколько,wie viele,cuántos
工作,gōng zuò,job/work/task,งาน,công việc,ວຽກ,travail/emploi,仕事,일/작업,работа,Arbeit/Job,trabajo/empleo
律师,lǜ shī,lawyer/attorney,ทนายความ,luật sư,ທະນາຍຄວາມ,avocat,弁護士,변호사,адвокат,Anwalt,abogado
医生,yīs hēng,doctor/medical practitioner,หมอ/แพทย์,bác sĩ,ຫມໍ/ແພດ,médecin/docteur,医者,의사,врач/доктор,Arzt,médico/doctor';

    
    function parseDemo(txt){
      if(!txt) return [];
      // Normalize
      txt = txt.replace(/\uFEFF/g, '');               // BOM
      txt = txt.replace(/，|；|;/g, ',');              // CN comma/semicolon -> comma
      txt = txt.replace(/\t/g, ',');                  // tabs -> comma
      txt = txt.replace(/\r\n?/g, '\n');              // CRLF/LF -> LF
      txt = txt.replace(/\n{2,}/g, '\n');             // collapse blank lines
      const lines0 = txt.split(/\n/).map(s=>s.trim()).filter(Boolean);
      // Drop header if present
      const hasHeader = lines0.length && /(中文|汉字|chinese|拼音|pinyin|英语|english|en)\b/i.test(lines0[0]);
      const lines = hasHeader ? lines0.slice(1) : lines0;
      const out = [];
      for(const line of lines){
        // split on commas; keep empties
        const parts = line.split(',').map(s=>s.trim());
        if(parts.length < 3) continue;                         // need cn/py/en
        while(parts.length < 12) parts.push('');               // pad
        const [cn, py, en] = parts;
        if(!cn || !py || !en) continue;                        // require first 3
        for(let i=3;i<12;i++){ if(!parts[i]) parts[i]=en; }    // fallback to English
        const [th,vi,lo,fr,ja,ko,ru,de,es] = parts.slice(3,12);
        out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]);
      }
      return out;
    }


    const demoDataFull = parseDemo(DEMO_TXT);
    const BUILTIN_LIMIT = 20;
    const demoData = demoDataFull.slice(0, BUILTIN_LIMIT); // exactly 20

    // Language list (default English)
    const LANGS = [
      {code:'en', name:'英语 English',     idx:0, color:'#ffffff'},
      {code:'th', name:'泰语 Thai',        idx:1, color:'#ffd37a'},
      {code:'vi', name:'越南语 Vietnamese',idx:2, color:'#7afcff'},
      {code:'lo', name:'老挝语 Lao',       idx:3, color:'#8ec5ff'},
      {code:'fr', name:'法语 Français',    idx:4, color:'#d6b7ff'},
      {code:'ja', name:'日语 日本語',      idx:5, color:'#ff91a9'},
      {code:'ko', name:'韩语 한국어',      idx:6, color:'#9dffa8'},
      {code:'ru', name:'俄语 Русский',     idx:7, color:'#ffc7a5'},
      {code:'de', name:'德语 Deutsch',     idx:8, color:'#c6ffef'},
      {code:'es', name:'西班牙语 Español', idx:9, color:'#fdd8ff'}
    ];

    function parseTrial(text){
      const rows = text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      if(!rows.length) return [];
      const header = rows[0].split(/[,\t]/).map(s=>s.trim().toLowerCase());
      const hasHeader = header.some(h=>/中文|汉字|cn|拼音|pinyin|英语|english|en/.test(h));
      const lines = hasHeader ? rows.slice(1) : rows;
      let idx = { cn:0, py:1, en:2, th:-1, vi:-1, lo:-1, fr:-1, ja:-1, ko:-1, ru:-1, de:-1, es:-1 };
      if(hasHeader){
        const map = {cn:['中文','汉字','chinese','cn'], py:['拼音','pinyin','py'], en:['英语','english','en'], th:['泰','thai','th'], vi:['越','viet','vi'], lo:['老挝','lao','lo'], fr:['法','français','fr'], ja:['日','japanese','ja'], ko:['韩','korean','ko'], ru:['俄','russian','ru'], de:['德','german','de'], es:['西','spanish','es']};
        Object.keys(map).forEach(k=>{
          for(const key of map[k]){
            const i = header.findIndex(h=>h.includes(key));
            if(i>=0){ idx[k]=i; break; }
          }
        });
      }
      const out = [];
      for(const line of lines){
        const p = line.split(/[,\t]/).map(s=>s.trim());
        const cn = p[idx.cn]||p[0]||'';
        const py = p[idx.py]||p[1]||'';
        const en = p[idx.en]||p[2]||'';
        if(!cn || !py || !en) continue;
        const langs = [en,
          idx.th>=0?(p[idx.th]||''):en, idx.vi>=0?(p[idx.vi]||''):en, idx.lo>=0?(p[idx.lo]||''):en,
          idx.fr>=0?(p[idx.fr]||''):en, idx.ja>=0?(p[idx.ja]||''):en, idx.ko>=0?(p[idx.ko]||''):en,
          idx.ru>=0?(p[idx.ru]||''):en, idx.de>=0?(p[idx.de]||''):en, idx.es>=0?(p[idx.es]||''):en
        ];
        out.push({cn, py, langs});
      }
      return out;
    }

    let state = {
      level: 1,
      passed: Number(localStorage.getItem('dev_demo_passed')||0),
      total: demoData.length, // 20
      langIdx: 0, // default English
      choice: { cn:null, py:null, tr:null },
      tiles: { cn:[], py:[], tr:[] ,
        congrats: "¡Enhorabuena por completar la demo!"
    },
      mapping: {},
      wrongBook: JSON.parse(localStorage.getItem('dev_demo_wrong')||'[]'),
      matchedCount: 0,
      usingTrial: false,
      trialWords: []
    };

    function shade(hex, k){
      const c = hex.replace('#','');
      const r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
      const rr = Math.round(r*k+255*(1-k)), gg = Math.round(g*k+255*(1-k)), bb = Math.round(b*k+255*(1-k));
      return 'rgb(${rr},${gg},${bb})';
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=a[i]; a[i]=a[j]; a[j]=t; } return a; }

    function buildLangRow(){
      const row = document.getElementById('langRow');
      row.innerHTML = '';
      LANGS.forEach(L=>{
        const b = document.createElement('button');
        b.className = 'lang-btn';
        b.style.backgroundImage = 'linear-gradient(180deg,#fff,${shade(L.color,0.9)})';
        b.textContent = L.name;
        if(L.idx===state.langIdx) b.classList.add('active');
        b.addEventListener('click', ()=>{
          state.langIdx = L.idx;
          document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
          updateTransTexts();
        });
        row.appendChild(b);
      });
      row.addEventListener('pointerdown', ()=> ensureAudio(), { once:true });
    }

    function initDemo(useTrial=false){
      state.usingTrial = !!useTrial;
      state.level = 1;
      document.getElementById('total').textContent = state.total;
      document.getElementById('passed').textContent = state.passed;
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      buildLangRow();
      if(useTrial){
        const tw = store.trial || [];
        state.trialWords = tw.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        makeRoundTrial();
      }else{
        makeRoundBuiltin(); // built-in 4 groups of 5
      }
    }

    function makeRoundBuiltin(){
      const N = 5;
      const MAX_LEVELS = 4;
      if(state.level>MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, '试玩单词已用完（内置 20 个，4 关）。');
        return;
      }
      const start = (state.level-1)*N; // fixed partition
      const slice = demoData.slice(start, start+N);
      const words = slice.map((w, idx)=>{
        const id = start+idx; // 0..19 stable id
        return { id, cn: w[0], py: w[1], tr: w[2][state.langIdx] };
      });
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      renderBoard();
    }

    function makeRoundTrial(){
      const N = 5;
      const MAX_LEVELS = Math.min(4, Math.ceil(state.trialWords.length / N));
      if(state.level > MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, '导入试玩单词已用完。');
        return;
      }
      const start = (state.level-1)*N;
      const slice = state.trialWords.slice(start, start+N);
      const words = slice.map((w)=>({ id:w.id, cn:w.cn, py:w.py, tr:(w.langs[state.langIdx]||w.langs[0]) }));
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      renderBoard();
    }

    function renderBoard(){
      const cn = document.getElementById('colCN');
      const py = document.getElementById('colPY');
      const tr = document.getElementById('colTR');
      cn.innerHTML = py.innerHTML = tr.innerHTML = '';
      ['cn','py','tr'].forEach(kind=>{
        const col = kind==='cn'?cn:kind==='py'?py:tr;
        state.tiles[kind].forEach(t=>{
          const el = document.createElement('div');
          el.className = 'tile'; el.textContent = t.text; el.dataset.id = t.id; el.dataset.kind = kind;
          el.addEventListener('click', ()=>onPick(el));
          col.appendChild(el);
        });
      });
      updateOverlay(false, '本关完成！');
      state.choice = {cn:null,py:null,tr:null};
    }

    function renderBoardEmpty(){
      ['colCN','colPY','colTR'].forEach(id=>{ document.getElementById(id).innerHTML=''; });
    }

    function updateTransTexts(){
      const trCol = document.getElementById('colTR');
      trCol.querySelectorAll('.tile').forEach(node=>{
        const id = Number(node.dataset.id);
        let text;
        if(state.usingTrial){
          const w = state.trialWords[id];
          text = (w && w.langs[state.langIdx]) || (w && w.langs[0]) || '';
        }else{
          const w = demoData[id];
          text = w ? w[2][state.langIdx] : '';
        }
        node.textContent = text;
      });
      state.tiles.tr = Array.from(trCol.querySelectorAll('.tile')).map(n=>({id:Number(n.dataset.id), text:n.textContent}));
    }

    function onPick(el){
      const kind = el.dataset.kind; const id = Number(el.dataset.id);
      if(el.classList.contains('selected')){ el.classList.remove('selected'); state.choice[kind]=null; return; }
      document.querySelectorAll('.tile[data-kind="${kind}"]').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected'); state.choice[kind]=id;
      const {cn,py,tr} = state.choice;
      if(cn!==null && py!==null && tr!==null){
        const ok = (cn===py && py===tr);
        if(ok){
          playSfx('ok');
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector('.tile[data-kind="${k}"][data-id="${state.choice[k]}"]');
            if(node){ node.classList.add('correct'); setTimeout(()=>node.remove(), 600); }
          });
          state.matchedCount += 1;
          const targetCount = 5;
          if(state.matchedCount>=targetCount){
            state.passed += 1;
            localStorage.setItem('dev_demo_passed', state.passed);
            document.getElementById('passed').textContent = state.passed;
            setTimeout(()=>{ updateOverlay(true, '本关完成！'); playSfx('done'); }, 650);
          }
          state.choice = {cn:null,py:null,tr:null};
        }else{
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector('.tile[data-kind="${k}"][data-id="${state.choice[k]}"]');
            if(node){ node.classList.add('wrong'); setTimeout(()=>node.classList.remove('wrong'), 260); }
          });
          playSfx('err');
          const anyId = cn ?? py ?? tr;
          if(Number.isFinite(anyId)){
            let wcn='', wpy='', wtr='';
            if(state.usingTrial){
              const w = state.trialWords[anyId]; if(w){ wcn=w.cn; wpy=w.py; wtr=w.langs[state.langIdx]||w.langs[0]; }
            }else{
              const w = demoData[anyId]; if(w){ wcn=w[0]; wpy=w[1]; wtr=w[2][state.langIdx]; }
            }
            if(wcn && wpy && wtr){
              const book = state.wrongBook || [];
              book.push({cn:wcn, py:wpy, tr:wtr, lang:state.langIdx});
              state.wrongBook = book;
              localStorage.setItem('dev_demo_wrong', JSON.stringify(book));
            }
          }
          showToast('配对不正确，请重试 / Not a match','error');
        }
      }
    }

    function updateOverlay(show, text){
      const f = document.getElementById('finish');
      const t = document.getElementById('finishText');
      if(typeof text==='string') t.textContent = text;
      f.style.display = show? 'flex':'none';
    }

    // Bottom buttons
    document.getElementById('btnTip').addEventListener('click', ()=>{
      playSfx('click'); showToast('提示：先观察拼音结构，再点选中文→拼音→翻译。','info');
    });
    document.getElementById('btnShuffle').addEventListener('click', ()=>{
      playSfx('shuffle'); ['cn','py','tr'].forEach(k=>{ state.tiles[k]=state.tiles[k].sort(()=>Math.random()-0.5); });
      renderBoard();
    });
    document.getElementById('btnSave').addEventListener('click', ()=>{
      localStorage.setItem('dev_demo_wrong', JSON.stringify(state.wrongBook));
      localStorage.setItem('dev_demo_passed', state.passed);
      playSfx('click'); showToast('进度已保存 / Progress saved','success');
    });
    document.getElementById('btnBack').addEventListener('click', ()=>{
      playSfx('click');
      document.getElementById('gameDemo').style.display='none';
      stage.style.display='block';
    });

    document.getElementById('btnPrev').addEventListener('click', ()=>{
      if(state.level>1){ state.level--; }
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, '本关完成！');
    });
    document.getElementById('btnNext').addEventListener('click', ()=>{
      state.level++;
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, '本关完成！');
      if(!state.usingTrial && state.level>4){ showToast('内置试玩仅 4 关，共 20 个词。','info'); }
    });

    document.getElementById('jumpGo').addEventListener('click', ()=>{
      const v = parseInt(document.getElementById('jumpInput').value||'1',10);
      state.level = Math.max(1, Math.min(4, v)); // bound to 1..4 for built-in demo
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, '本关完成！');
    });

    // Wrong book
    const wrongPad = document.getElementById('wrongPad');
    document.getElementById('btnWrong').addEventListener('click', ()=>{ renderWrong(); wrongPad.style.display='block'; });
    document.getElementById('wrongClose').addEventListener('click', ()=> wrongPad.style.display='none');
    document.getElementById('wrongClear').addEventListener('click', ()=>{ state.wrongBook=[]; localStorage.setItem('dev_demo_wrong','[]'); renderWrong(); });

    function renderWrong(){
      const list = document.getElementById('wrongList');
      list.innerHTML = '';
      if(!state.wrongBook.length){
        list.innerHTML = '<div class="witem">暂无记录 / Empty</div>';
        return;
      }
      state.wrongBook.slice().reverse().forEach((it)=>{
        const d = document.createElement('div');
        d.className = 'witem';
        d.textContent = it.cn + ' ｜ ' + it.py + ' ｜ ' + it.tr;
        list.appendChild(d);
      });
    }
  
  <script>
    // ===== Localization (Chinese + selected language) =====
    // Order of LANGS corresponds to UI_LANGS below (idx 0..9)
    const UI_LANGS = {
      en: {
        tips: "Tips", reshuffle: "Reshuffle", save: "Save", back: "Back",
        wrongbook: "Wrong Book", backMenu: "Back to Menu", next: "Next",
        prev: "Previous", level: "Level", progress: "Progress",
        jumpTo: "Jump to", levelUnit: "Level", go: "Go",
        hintText: (cn,py,tr) => 'Hint: “${cn,
        congrats: "Congratulations on completing the demo!"
    } – ${py} – ${tr}” is a correct match.',
        demoOverTitle: "Demo Completed",
        demoOverBody: "If you want to continue, please go to “Import & Play”.",
        importPlay: "Import & Play",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      th: {
        tips: "เคล็ดลับ", reshuffle: "สับใหม่", save: "บันทึก", back: "ย้อนกลับ",
        wrongbook: "สมุดคำผิด", backMenu: "กลับสู่เมนู", next: "ถัดไป",
        prev: "ก่อนหน้า", level: "ด่าน", progress: "ความคืบหน้า",
        jumpTo: "ไปยังด่าน", levelUnit: "ด่าน", go: "ตกลง",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "จบการทดลองเล่น",
        demoOverBody: "หากต้องการเล่นต่อ โปรดไปที่ “นำเข้าคลังคำแล้วเล่น”",
        importPlay: "นำเข้า & เล่น",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      vi: {
        tips: "Gợi ý", reshuffle: "Xáo lại", save: "Lưu", back: "Quay lại",
        wrongbook: "Sổ từ sai", backMenu: "Về menu", next: "Tiếp",
        prev: "Trước", level: "Cấp", progress: "Tiến độ",
        jumpTo: "Nhảy đến", levelUnit: "Cấp", go: "Đi",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "Kết thúc bản chơi thử",
        demoOverBody: "Muốn chơi tiếp, hãy đến “Nhập từ & chơi”.",
        importPlay: "Nhập & Chơi",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      lo: {
        tips: "ແນະນໍາ", reshuffle: "ສັບໃໝ່", save: "ບັນທຶກ", back: "ກັບ",
        wrongbook: "ສົດຄຳຜິດ", backMenu: "ກັບເມນູ", next: "ຕໍ່ໄປ",
        prev: "ກ່ອນໜ້າ", level: "ດ່ານ", progress: "ຄວາມຄືບໜ້າ",
        jumpTo: "ໄປທີ່", levelUnit: "ດ່ານ", go: "Go",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "ສິ້ນສຸດການທົດລອງ",
        demoOverBody: "ຖ້າຢາກຫຼິ້ນຕໍ່ ກະລຸນາໄປ “ນໍາເຂົ້າ & ຫຼິ້ນ”",
        importPlay: "ນໍາເຂົ້າ & ຫຼິ້ນ",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      fr: {
        tips: "Astuce", reshuffle: "Mélanger", save: "Enregistrer", back: "Retour",
        wrongbook: "Fautes", backMenu: "Retour au menu", next: "Suivant",
        prev: "Précédent", level: "Niveau", progress: "Progrès",
        jumpTo: "Aller au", levelUnit: "niveau", go: "Aller",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "Démo terminée",
        demoOverBody: "Pour continuer, allez à « Importer & Jouer ».",
        importPlay: "Importer & Jouer",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      ja: {
        tips: "ヒント", reshuffle: "シャッフル", save: "保存", back: "戻る",
        wrongbook: "間違い帳", backMenu: "メニューへ戻る", next: "次へ",
        prev: "前へ", level: "レベル", progress: "進捗",
        jumpTo: "移動先", levelUnit: "レベル", go: "Go",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "体験版は終了しました",
        demoOverBody: "続けるには「インポートしてプレイ」へ。",
        importPlay: "インポートしてプレイ",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      ko: {
        tips: "힌트", reshuffle: "섞기", save: "저장", back: "뒤로",
        wrongbook: "오답노트", backMenu: "메뉴로", next: "다음",
        prev: "이전", level: "레벨", progress: "진행",
        jumpTo: "이동", levelUnit: "레벨", go: "Go",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "체험 종료",
        demoOverBody: "계속하려면 ‘가져오기 & 플레이’를 이용하세요.",
        importPlay: "가져오기 & 플레이",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      ru: {
        tips: "Подсказка", reshuffle: "Перемешать", save: "Сохранить", back: "Назад",
        wrongbook: "Ошибки", backMenu: "В меню", next: "Далее",
        prev: "Назад", level: "Уровень", progress: "Прогресс",
        jumpTo: "Перейти к", levelUnit: "ур.", go: "Go",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "Демо завершено",
        demoOverBody: "Чтобы продолжить, перейдите к «Импорт и игра».",
        importPlay: "Импорт и игра",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      de: {
        tips: "Tipp", reshuffle: "Neu mischen", save: "Speichern", back: "Zurück",
        wrongbook: "Fehlerheft", backMenu: "Zurück zum Menü", next: "Weiter",
        prev: "Zurück", level: "Level", progress: "Fortschritt",
        jumpTo: "Springe zu", levelUnit: "Level", go: "Los",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "Demo beendet",
        demoOverBody: "Zum Weiterspielen gehe zu „Importieren & Spielen“.",
        importPlay: "Importieren & Spielen",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      es: {
        tips: "Pista", reshuffle: "Barajar", save: "Guardar", back: "Volver",
        wrongbook: "Errores", backMenu: "Volver al menú", next: "Siguiente",
        prev: "Anterior", level: "Nivel", progress: "Progreso",
        jumpTo: "Ir a", levelUnit: "nivel", go: "Ir",
        hintText: (cn,py,tr)=>('Hint: “' + cn + ' – ' + py + ' – ' + tr + '”'),
        demoOverTitle: "Demo finalizada",
        demoOverBody: "Para continuar, ve a «Importar y jugar».",
        importPlay: "Importar y jugar",
        moduleEnter: (name)=>('Enter module: ' + name)
      }
    };

    function getUILangObj(){
      const code = LANGS.find(L=>L.idx===state.langIdx)?.code || 'en';
      return UI_LANGS[code] || UI_LANGS['en'];
    }

    function setBilingualText(el, zh, key){
      const L = getUILangObj();
      const other = (typeof L[key]==='function') ? '' : (L[key] || '');
      if(el) el.textContent = zh + " / " + other;
    }

    function refreshUITexts(){
      const L = getUILangObj();
      // Top labels
      document.getElementById('levelInfo').innerHTML = '关卡：<strong>'+state.level+'</strong> / ' + L.level + ' <strong>'+state.level+'</strong>';
      document.querySelector('.progress').innerHTML = '进度 <span id="passed">'+state.passed+'</span>/<span id="total">'+state.total+'</span> / ' + L.progress + ' <span>'+state.passed+'</span>/<span>'+state.total+'</span>';
      // Jump widgets
      document.querySelector('.jump label').firstChild.textContent = '跳往第 ';
      document.querySelector('.jump label').lastChild.textContent = ' 关';
      document.getElementById('jumpGo').textContent = L.go;

      // Bottom buttons
      setBilingualText(document.getElementById('btnTip'), '提示', 'tips');
      setBilingualText(document.getElementById('btnShuffle'), '重排序', 'reshuffle');
      setBilingualText(document.getElementById('btnSave'), '保存', 'save');
      setBilingualText(document.getElementById('btnBack'), '返回上一级', 'back');
      setBilingualText(document.getElementById('btnWrong'), '错词本', 'wrongbook');

      // Stage buttons
      setBilingualText(document.getElementById('btnBackTop'), '返回主菜单', 'backMenu');
      document.getElementById('actImport').innerHTML = '导入词库玩游戏<br><small>'+ (getUILangObj().importPlay || 'Import & Play') +'</small>';
    }

    // ===== Tips feature =====
    // v15: Refresh UI after language button click and on load
    document.addEventListener('click', function(e){
      const t = e.target;
      if(t && t.classList && t.classList.contains('lang-btn')){
        setTimeout(()=>{ if(typeof refreshUITexts==='function') refreshUITexts(); }, 0);
      }
    });
    window.addEventListener('load', function(){
      setTimeout(()=>{ if(typeof refreshUITexts==='function') refreshUITexts(); }, 0);
    });
    
    let tipsLeft = 4;
    function doTip(){
      if(tipsLeft<=0){ showToast('已无可用提示 / ' + getUILangObj().tips + ' 0'); return; }
      // Find an unmatched id (present in all three columns)
      const ids = new Set(state.tiles.cn.map(t=>t.id));
      const id = Array.from(ids)[Math.floor(Math.random()*ids.size)];
      const w = state.usingTrial ? state.trialWords[id] : demoData[id];
      if(!w) return;
      const cn = state.usingTrial ? w.cn : w[0];
      const py = state.usingTrial ? w.py : w[1];
      const tr = state.usingTrial ? (w.langs[state.langIdx]||w.langs[0]) : w[2][state.langIdx];
      // highlight
      ['cn','py','tr'].forEach(k=>{
        const node = document.querySelector('.tile[data-kind="${k}"][data-id="${id}"]');
        if(node){
          node.style.boxShadow = '0 0 0 3px var(--tileC), 0 0 22px rgba(0,0,0,.25)';
          node.style.filter = 'saturate(1.2)';
          setTimeout(()=>{ node.style.boxShadow=''; node.style.filter=''; }, 1200);
        }
      });
      const L = getUILangObj();
      showToast('提示：‘${cn} – ${py} – ${tr}’ 是一组正确配对。 / ' + (L.hintText(cn,py,tr)), 'info');
      tipsLeft--;
    }

    document.getElementById('btnTip').addEventListener('click', ()=>{ playSfx('click'); doTip(); });

    // Hook language changes to update UI texts (guarded)
if (typeof buildLangRow === 'function') {
  const __oldBuildLangRow = buildLangRow;
  buildLangRow = function(){
    __oldBuildLangRow();
    refreshUITexts();
  };
}


    // Ensure texts are set at init and after level changes (guarded)
if (typeof renderBoard === 'function') {
  const __oldRenderBoard = renderBoard;
  renderBoard = function(){
    __oldRenderBoard();
    refreshUITexts();
    tipsLeft = 4; // reset tips per round
  };
}


    
    
    // ===== Demo end message (after level 4) =====
    (function(){
      function attachDemoEndOverride(){
        if (typeof makeRoundBuiltin !== 'function') return false;
        const __oldMakeRoundBuiltin = makeRoundBuiltin;
        makeRoundBuiltin = function(){
          const N = 5, MAX_LEVELS = 4;
          if(state.level>MAX_LEVELS){
            renderBoardEmpty && renderBoardEmpty();
            const L = getUILangObj ? getUILangObj() : {};
            // Bilingual end text with congrats
            const msg = '试玩结束 / ' + (L.demoOverTitle || 'Demo Completed') + ' — ' +
                        (L.demoOverBody || 'If you want to continue, please go to “Import & Play”.');
            const congrats = (L.congrats || 'Congratulations on completing the demo!');
            updateOverlay && updateOverlay(true, congrats + '  ' + msg);
            const f = document.getElementById('finish');
            if(!f) return;
            const prevBtn = document.getElementById('btnPrev');
            const nextBtn = document.getElementById('btnNext');
            if(prevBtn) prevBtn.style.display = 'none';
            if(nextBtn) nextBtn.style.display = 'none';
            // Back to menu (bilingual)
            if(!document.getElementById('btnToMenu')){
              const btn = document.createElement('button');
              btn.className = 'btn'; btn.id = 'btnToMenu';
              btn.textContent = '返回主菜单 / ' + ((L.backMenu)||'Back to Menu');
              btn.addEventListener('click', ()=>{
                document.getElementById('gameDemo').style.display='none';
                document.getElementById('stage').style.display='block';
                updateOverlay && updateOverlay(false);
              });
              f.appendChild(btn);
            }
            // Replay (bilingual)
            if(!document.getElementById('btnReplay')){
              const rbtn = document.createElement('button');
              rbtn.className = 'btn'; rbtn.id = 'btnReplay';
              rbtn.textContent = '重新试玩 / ' + ((L.replay)||'Replay');
              rbtn.addEventListener('click', ()=>{
                document.getElementById('gameDemo').style.display='block';
                document.getElementById('stage').style.display='none';
                state.level = 1;
                state.passed = 0;
                tipsLeft = 4;
                updateOverlay && updateOverlay(false);
                __oldMakeRoundBuiltin();
              });
              f.appendChild(rbtn);
            }
            return;
          }
          __oldMakeRoundBuiltin();
        };
        return true;
      }
      if(!attachDemoEndOverride()){
        window.addEventListener('load', attachDemoEndOverride);
      }
    })();

    makeRoundBuiltin = function(){
      const N = 5, MAX_LEVELS = 4;
      if(state.level>MAX_LEVELS){
        renderBoardEmpty();
        const L = getUILangObj();
        // Bilingual end text
        updateOverlay(true, '试玩结束 / ' + (L.demoOverTitle || 'Demo Completed') + ' — ' + (L.demoOverBody || 'If you want to continue, please go to “Import & Play”.'));
        const f = document.getElementById('finish');
        const prevBtn = document.getElementById('btnPrev');
        const nextBtn = document.getElementById('btnNext');
        if(prevBtn) prevBtn.style.display = 'none';
        if(nextBtn) nextBtn.style.display = 'none';
        // Back to menu (bilingual)
        if(!document.getElementById('btnToMenu')){
          const btn = document.createElement('button');
          btn.className = 'btn'; btn.id = 'btnToMenu';
          btn.textContent = '返回主菜单 / ' + ((L.backMenu)||'Back to Menu');
          btn.addEventListener('click', ()=>{
            document.getElementById('gameDemo').style.display='none';
            document.getElementById('stage').style.display='block';
            updateOverlay(false);
          });
          f.appendChild(btn);
        }
        // Replay (bilingual title)
        if(!document.getElementById('btnReplay')){
          const rbtn = document.createElement('button');
          rbtn.className = 'btn'; rbtn.id = 'btnReplay';
          rbtn.textContent = '重新试玩 / ' + ((L.replay)||'Replay');
          rbtn.addEventListener('click', ()=>{
            document.getElementById('gameDemo').style.display='block';
            document.getElementById('stage').style.display='none';
            state.level = 1;
            state.passed = 0;
            tipsLeft = 4;
            updateOverlay(false);
            __oldMakeRoundBuiltin();
          });
          f.appendChild(rbtn);
        }
        return;
      }
      __oldMakeRoundBuiltin();
    };
  
// ===== v17: Global bilingual UI (Chinese / English) =====
(function(){
  function setText(id, zh, en){
    var el = document.getElementById(id);
    if(el){ el.textContent = zh + ' / ' + en; }
  }
  function applyBilingualUI(){
    // Top bars & buttons
    setText('btnBackTop','返回主菜单','Back to Menu');
    setText('btnTip','提示','Tips');
    setText('btnShuffle','重排序','Reshuffle');
    setText('btnSave','保存','Save');
    setText('btnBack','返回上一级','Back');
    setText('btnWrong','错词本','Wrong Book');

    // Stage actions
    var actDemo = document.getElementById('actDemo'); if(actDemo) actDemo.innerHTML = '试玩游戏 / Demo<br><small>内置 20 个 / Built-in 20</small>';
    var actImport = document.getElementById('actImport'); if(actImport) actImport.innerHTML = '导入词库玩游戏 / Import & Play<br><small>选择文件 / Choose a file</small>';

    // Progress labels (keep numbers)
    var levelInfo = document.getElementById('levelInfo');
    if(levelInfo){ levelInfo.innerHTML = '关卡：<strong>'+ (window.state && state.level || 1) +'</strong> / Level <strong>'+ (window.state && state.level || 1) +'</strong>'; }
    var prog = document.querySelector('.progress');
    if(prog){
      var passed = document.getElementById('passed') ? document.getElementById('passed').textContent : '0';
      var total = document.getElementById('total') ? document.getElementById('total').textContent : '0';
      prog.innerHTML = '进度 <span id=\"passed\">'+passed+'</span>/<span id=\"total\">'+total+'</span> / Progress <span>'+passed+'</span>/<span>'+total+'</span>';
    }

    // Jump row
    var jumpGo = document.getElementById('jumpGo'); if(jumpGo) jumpGo.textContent = 'Go';
  }
  window.applyBilingualUI = applyBilingualUI;
  window.addEventListener('load', function(){ setTimeout(applyBilingualUI, 0); });
  document.addEventListener('click', function(e){
    var t = e.target;
    if(t && t.classList && t.classList.contains('lang-btn')){
      setTimeout(applyBilingualUI, 0);
    }
  });
})();

// ===== v17: End-of-demo overlay with Replay & Back (bilingual) =====
(function(){
  function attach(){
    if(typeof makeRoundBuiltin !== 'function') return false;
    var __old = makeRoundBuiltin;
    makeRoundBuiltin = function(){
      var N = 5, MAX_LEVELS = 4;
      if(window.state && state.level>MAX_LEVELS){
        if(typeof renderBoardEmpty==='function') renderBoardEmpty();
        if(typeof updateOverlay==='function') updateOverlay(true, '恭喜完成试玩！ / Congratulations on completing the demo!  试玩结束 / Demo Completed — 若想继续，请前往“导入词库玩游戏” / If you want to continue, please go to “Import & Play”.');
        var f = document.getElementById('finish'); if(!f) return;
        var prevBtn = document.getElementById('btnPrev'); if(prevBtn) prevBtn.style.display='none';
        var nextBtn = document.getElementById('btnNext'); if(nextBtn) nextBtn.style.display='none';
        // Back to Menu
        if(!document.getElementById('btnToMenu')){
          var backBtn = document.createElement('button');
          backBtn.className = 'btn'; backBtn.id = 'btnToMenu';
          backBtn.textContent = '返回主菜单 / Back to Menu';
          backBtn.onclick = function(){
            document.getElementById('gameDemo').style.display='none';
            document.getElementById('stage').style.display='block';
            if(typeof updateOverlay==='function') updateOverlay(false);
          };
          f.appendChild(backBtn);
        }
        // Replay
        if(!document.getElementById('btnReplay')){
          var rbtn = document.createElement('button');
          rbtn.className = 'btn'; rbtn.id = 'btnReplay';
          rbtn.textContent = '重新试玩 / Replay Demo';
          rbtn.onclick = function(){
            document.getElementById('gameDemo').style.display='block';
            document.getElementById('stage').style.display='none';
            if(window.state){ state.level=1; state.passed=0; }
            if(typeof updateOverlay==='function') updateOverlay(false);
            if(typeof __old==='function') __old();
            if(typeof window.applyBilingualUI==='function') setTimeout(window.applyBilingualUI, 0);
          };
          f.appendChild(rbtn);
        }
        return;
      }
      if(typeof __old==='function') __old();
    };
    return true;
  }
  if(!attach()){ window.addEventListener('load', attach); }
})();

// ===== v17: Tips localization to bilingual (CN/EN) & count per round reset =====
(function(){
  function tipInfoText(cn,py,tr){
    return '提示：' + cn + ' – ' + py + ' – ' + tr + ' 是一组正确配对。 / Hint: “' + cn + ' – ' + py + ' – ' + tr + '” is a correct match.';
  }
  var oldOnTip = document.getElementById('btnTip') && document.getElementById('btnTip').onclick;
  // Keep existing click listener but we also set a global handler to reset tipsLeft each render if renderBoard exists
  var binder = function(){
    var btn = document.getElementById('btnTip');
    if(!btn) return;
    btn.addEventListener('click', function(){ setTimeout(function(){ if(typeof window.applyBilingualUI==='function') window.applyBilingualUI(); }, 0); });
  };
  window.addEventListener('load', binder);
  // Reset tipsLeft on renderBoard if available
  if(typeof renderBoard==='function'){
    var __rb = renderBoard;
    renderBoard = function(){
      __rb();
      try{ tipsLeft = 4; }catch(e){}
      if(typeof window.applyBilingualUI==='function') window.applyBilingualUI();
    };
  } else {
    window.addEventListener('load', function(){
      try{ tipsLeft = 4; }catch(e){}
    });
  }
})();

</script>
</body>
</html>