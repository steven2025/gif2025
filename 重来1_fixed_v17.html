<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HSKÂçïËØçÊ∏∏Êàè ¬∑ HSK Word Game (Fixed v5)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2b;
      --neon1:#7afcff;
      --neon2:#b693ff;
      --neon3:#5cff9d;
      --btnDepth: 14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1000px 500px at 10% -20%, rgba(122,252,255,.12), transparent 60%),
                  radial-gradient(800px 400px at 90% 0%, rgba(182,147,255,.12), transparent 55%),
                  linear-gradient(180deg, #0b1220 0%, #0a0f1c 100%);
      color:#e9f1ff; overflow-x:hidden;
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px 16px 56px; }

    .hero{ position:relative; border-radius:18px; padding:32px 20px; margin-top:8px; margin-bottom:18px;
      background: linear-gradient(145deg, rgba(17,26,43,.92), rgba(15,23,39,.75));
      box-shadow: inset 0 0 0 1px rgba(122,252,255,.08), 0 30px 80px rgba(0,0,0,.45); overflow:hidden; }
    .hero::before{ content:""; position:absolute; inset:-2px; border-radius:20px;
      background: conic-gradient(from 210deg, rgba(122,252,255,.15), rgba(182,147,255,.18), rgba(92,255,157,.15), rgba(122,252,255,.15));
      filter: blur(26px); opacity:.55; pointer-events:none; mask: radial-gradient(120% 120% at 50% 0%, black 40%, transparent 55%); }
    .title-cn,.title-en{ text-align:center; margin:0; letter-spacing:2px; }
    .title-cn{ font-size:42px; font-weight:800; }
    .title-en{ font-size:28px; font-weight:700; opacity:.92; }
    .glowtext{ background: linear-gradient(90deg, #e9f1ff, #8ee7ff, #c4b5ff, #9bffcc, #e9f1ff); background-size:200% 100%;
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: hueMove 10s linear infinite, shimmer 3.6s ease-in-out infinite; text-shadow: 0 0 12px rgba(122,252,255,.15), 0 0 22px rgba(182,147,255,.12); }
    @keyframes hueMove{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
    @keyframes shimmer{ 0%,100%{filter:drop-shadow(0 0 0 rgba(0,0,0,0))} 50%{filter:drop-shadow(0 0 14px rgba(122,252,255,.35))} }

    .top-actions{ display:flex; gap:12px; align-items:center; padding:12px 4px 0; }
    .top-actions .spacer{ flex:1; }

    .btn{ --c1:var(--neon1); --c2:var(--neon2); position:relative; border:none; outline:none; cursor:pointer; user-select:none; font-weight:700; font-size:14px; letter-spacing:.3px; color:#0b1220; padding:12px 18px; border-radius:12px;
      background: linear-gradient(180deg, white, #dfe8ff);
      box-shadow: 0 var(--btnDepth) 0 rgba(0,0,0,.35), 0 8px 24px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.7), 0 0 0 1px rgba(122,252,255,.25), 0 0 24px rgba(182,147,255,.25);
      transition: transform .15s ease, box-shadow .15s ease;
      background-image: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,244,255,.95)), radial-gradient(120% 140% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(120% 140% at 110% 120%, var(--c2) 0%, transparent 45%);
    }
    .btn:hover{ transform:translateY(-3px); box-shadow: 0 calc(var(--btnDepth)+3px) 0 rgba(0,0,0,.36), 0 18px 36px rgba(0,0,0,.45), 0 0 36px rgba(122,252,255,.35); }
    .btn:active{ transform:translateY(2px); box-shadow: 0 calc(var(--btnDepth)-2px) 0 rgba(0,0,0,.4), 0 8px 16px rgba(0,0,0,.35); }

    .sound-wrap{ display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:14px; background: rgba(255,255,255,.06); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .switch{ position:relative; width:54px; height:28px; background:#2a3652; border-radius:999px; cursor:pointer; box-shadow: inset 0 0 0 1px rgba(122,252,255,.2); }
    .switch::after{ content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background: linear-gradient(180deg, #fff, #e6eeff); box-shadow: 0 6px 12px rgba(0,0,0,.45); transition: left .2s ease; }
    .switch.on{ background: linear-gradient(90deg, rgba(122,252,255,.45), rgba(182,147,255,.45)); }
    .switch.on::after{ left:29px; }
    .volume{ accent-color:#7afcff; height:28px; }
    .label{ font-size:13px; opacity:.92; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:22px; margin-top:18px; }
    .grid .span2{ grid-column: span 2; }

    .card{ position:relative; border-radius:18px; padding:26px 24px; text-align:center; overflow:hidden; cursor:pointer; user-select:none; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 18px 60px rgba(0,0,0,.45); transition: transform .18s ease, box-shadow .18s ease, filter .18s ease; }
    .card:hover{ transform: translateY(-6px); filter:saturate(1.12); box-shadow: inset 0 0 0 1px rgba(122,252,255,.2), 0 24px 80px rgba(0,0,0,.55), 0 0 48px rgba(122,252,255,.28); }
    .card::before{ content:""; position:absolute; inset:0; background: radial-gradient(220px 120px at var(--mx,50%) var(--my,50%), rgba(122,252,255,.18), transparent 55%); pointer-events:none; transition: background .15s ease; }

    .cn{ font-size:26px; font-weight:800; margin-bottom:8px; text-shadow: 0 2px 0 rgba(0,0,0,.3), 0 0 18px rgba(122,252,255,.2); }
    .en{ font-size:16px; font-weight:700; opacity:.95; }

    .red{ background: linear-gradient(180deg, rgba(255,103,103,.15), rgba(255,103,103,.05)); }
    .green{ background: linear-gradient(180deg, rgba(76,252,169,.15), rgba(76,252,169,.05)); }
    .blue{ background: linear-gradient(180deg, rgba(91,157,255,.18), rgba(91,157,255,.06)); }
    .amber{ background: linear-gradient(180deg, rgba(255,199,95,.18), rgba(255,199,95,.06)); }
    .purple{ background: linear-gradient(180deg, rgba(208,143,255,.18), rgba(208,143,255,.06)); }
    .teal{ background: linear-gradient(180deg, rgba(86,236,255,.16), rgba(86,236,255,.06)); }

    .stage{ display:none; margin-top:18px; border-radius:20px; padding:28px 18px 34px; background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(235,243,255,.92)); color:#0e1422; box-shadow: inset 0 0 0 1px rgba(10,20,40,.08), 0 24px 80px rgba(0,0,0,.35); }
    .stage-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .module-title{ font-weight:900; font-size:28px; letter-spacing:.5px; background: linear-gradient(90deg, #1d2140, #193a59, #1d2140); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:none; }
    .subtitle{ font-size:14px; opacity:.7; }

    .stage-actions{ display:grid; grid-template-columns: repeat(2, 1fr); gap:22px; }
    
    .action-btn{ --c1:#00d4ff; --c2:#0077ff; color:#0a1020; font-weight:900; font-size:18px; padding:24px 18px; border-radius:18px; border:none; cursor:pointer; user-select:none; box-shadow: 0 14px 0 rgba(0,0,0,.25), 0 22px 54px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,255,255,.7); background-image: linear-gradient(180deg, rgba(255,255,255,.94), rgba(242,248,255,.99)), radial-gradient(140% 160% at -10% -10%, var(--c1) 0%, transparent 45%), radial-gradient(140% 160% at 110% 120%, var(--c2) 0%, transparent 45%); transition: transform .15s ease, box-shadow .15s ease; }
    .action-btn:hover{ transform: translateY(-4px); box-shadow: 0 16px 0 rgba(0,0,0,.26), 0 26px 64px rgba(0,0,0,.35); }
    .action-btn:active{ transform: translateY(2px); box-shadow: 0 9px 0 rgba(0,0,0,.3), 0 18px 36px rgba(0,0,0,.32); }
    .act-demo{ --c1:#7afcff; --c2:#8ec5ff; }
    .act-import{ --c1:#ffd37a; --c2:#ffb36b; }

    .game{ position:relative; display:none; margin-top:18px; border-radius:22px; background: linear-gradient(180deg, #f9fbff, #edf4ff); color:#0f1430; box-shadow: inset 0 0 0 1px rgba(12,22,44,.08), 0 24px 80px rgba(0,0,0,.35); }
    .game-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px 8px; border-bottom:1px dashed rgba(12,22,44,.12); }
    .game-left{ font-weight:900; font-size:18px; }
    .progress{ font-weight:800; font-size:14px; opacity:.85; }

    .lang-row{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px; }
    .lang-btn{ border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:800; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); transition:.15s; }
    .lang-btn.active{ outline:2px solid #0ea5e9; box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 22px 48px rgba(0,0,0,.22); }

    .jump{ display:flex; align-items:center; gap:8px; }
    .jump input{ width:86px; padding:8px 10px; border-radius:10px; border:1px solid rgba(12,22,44,.18); }

    .board{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; padding:18px; }
    .col{ display:grid; grid-template-rows: repeat(5, 64px); gap:12px; padding:12px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(240,245,255,.95)); box-shadow: inset 0 0 0 1px rgba(12,22,44,.08); }
    .col-cn{ --tileC:#ffb36b; }
    .col-py{ --tileC:#7de67f; }
    .col-tr{ --tileC:#7fb3ff; }

    .tile{ display:flex; align-items:center; justify-content:center; text-align:center; padding:10px; border-radius:12px; cursor:pointer; user-select:none; font-weight:900; color:#0b1220; background: linear-gradient(180deg, #fff, #eaf2ff); box-shadow: 0 10px 0 rgba(0,0,0,.18), 0 18px 44px rgba(0,0,0,.22), inset 0 0 0 2px rgba(255,255,255,.9), 0 0 0 1px rgba(0,0,0,.04); transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, opacity .3s ease; border:2px solid rgba(0,0,0,.06); position:relative; }
    .tile::after{ content:""; position:absolute; inset:0; border-radius:12px; box-shadow: inset 0 0 48px rgba( 0, 0, 0, .12 ); opacity:.9; }
    .tile:hover{ transform: translateY(-3px); box-shadow: 0 14px 0 rgba(0,0,0,.2), 0 28px 56px rgba(0,0,0,.26); }
    .tile.selected{ outline:3px solid var(--tileC); filter: saturate(1.15); }
    .tile.correct{ animation: flashOut .6s ease forwards; }
    .tile.wrong{ animation: shake .25s ease; }

    @keyframes flashOut{ 0%{ opacity:1; filter:brightness(1); } 50%{ opacity:.35; filter:brightness(1.6); } 100%{ opacity:0; transform: scale(.96); } }
    @keyframes shake{ 0%,100%{ transform:translateX(0); } 25%{ transform:translateX(-4px); } 75%{ transform:translateX(4px); } }

    .game-bottom{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; padding:10px 12px 20px; border-top:1px dashed rgba(12,22,44,.12); }
    .mini-btn{ border:none; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer; box-shadow: 0 8px 0 rgba(0,0,0,.15), 0 16px 36px rgba(0,0,0,.18), inset 0 0 0 1px rgba(255,255,255,.7); background: linear-gradient(180deg, #fff, #eef5ff); }

    .finish-overlay{ display:none; position:absolute; inset:0; backdrop-filter: blur(4px); background: rgba(255,255,255,.6); align-items:center; justify-content:center; gap:14px; padding:16px; text-align:center; }
    .finish-overlay .btn{ font-size:16px; }

    .wrongpad{ position:fixed; right:18px; bottom:18px; width:360px; max-height:60vh; overflow:auto; background:rgba(255,255,255,.92); border-radius:16px; box-shadow: 0 18px 54px rgba(0,0,0,.35); display:none; padding:16px; backdrop-filter: blur(6px); }
    .wrongpad h4{ margin:0 0 10px; color:#0e1422; font-weight:900; }
    .wrongpad .witem{ font-size:14px; padding:10px 12px; border-radius:12px; background:linear-gradient(180deg,#f2f7ff,#eaf1ff); color:#0b1220; box-shadow: inset 0 0 0 1px rgba(12,22,44,.09), 0 8px 22px rgba(0,0,0,.08); margin-bottom:10px; }

    @media (max-width: 900px){
      .stage-actions{ grid-template-columns: 1fr; }
      .board{ grid-template-columns: 1fr; }
      .col{ grid-template-rows: repeat(5, 58px); }
    }

    footer{ margin-top:28px; font-size:12px; opacity:.8; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <section class="hero" id="hero">
      <h1 class="title-cn glowtext">HSKÂçïËØçÊ∏∏Êàè</h1>
      <h2 class="title-en glowtext">HSK Word Game</h2>
      <div class="top-actions">
        <div class="spacer"></div>
        <button class="btn" id="btnRegister" aria-haspopup="dialog">Ê≥®ÂÜå Register</button>
        <button class="btn" id="btnLogin" aria-haspopup="dialog">ÁôªÂΩï Login</button>
        <div class="sound-wrap" title="Èü≥Êïà‰∏éÈü≥Èáè">
          <span class="label">Èü≥Êïà Sound</span>
          <div id="soundSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
          <input id="volume" class="volume" type="range" min="0" max="1" step="0.01" value="0.6" aria-label="Èü≥Èáè Volume" />
        </div>
      </div>
    </section>

    <section class="grid" id="menu">
      <div class="card red" data-key="dev-cn">
        <div class="cn">ÂèëÂ±ïÊ±âËØ≠ËØçÊ±á</div>
        <div class="en">Developing Chinese Vocabulary</div>
      </div>
      <div class="card green" data-key="hsk">
        <div class="cn">HSKËØçÊ±á</div>
        <div class="en">HSK Vocabulary</div>
      </div>
      <div class="card blue" data-key="fill">
        <div class="cn">ÈÄâËØçÂ°´Á©∫</div>
        <div class="en">Fill in the Blanks</div>
      </div>
      <div class="card amber" data-key="build">
        <div class="cn">ËØçËØ≠ÁªÑÂè•</div>
        <div class="en">Sentence Building</div>
      </div>
      <div class="card purple" data-key="order">
        <div class="cn">Âè•Â≠êÊéíÂ∫è</div>
        <div class="en">Sentence Ordering</div>
      </div>
      <div class="card teal" data-key="banks">
        <div class="cn">Ëé∑ÂèñËØçÂ∫ìÂíåÈ¢òÂ∫ì</div>
        <div class="en">Get Word & Question Banks</div>
      </div>
    </section>

    <section class="game" id="gameDemo" aria-hidden="true">
      <div class="game-top">
        <div class="game-left">
          <span id="levelInfo">ÂÖ≥Âç°Ôºö<strong>1</strong></span>
          &nbsp;|&nbsp;
          <span class="progress">ËøõÂ∫¶ <span id="passed">0</span>/<span id="total">0</span></span>
        </div>
        <div class="jump">
          <label>Ë∑≥ÂæÄÁ¨¨ <input type="number" id="jumpInput" min="1" value="1" /> ÂÖ≥</label>
          <button class="btn" id="jumpGo">Go</button>
        </div>
      </div>
      <div class="lang-row" id="langRow"></div>
      <div class="board" id="board">
        <div class="col col-cn" id="colCN" aria-label="‰∏≠ÊñáÂàó"></div>
        <div class="col col-py" id="colPY" aria-label="ÊãºÈü≥Âàó"></div>
        <div class="col col-tr" id="colTR" aria-label="ÁøªËØëÂàó"></div>
      </div>
      <div class="game-bottom">
        <button class="mini-btn" id="btnTip">ÊèêÁ§∫ / Tips</button>
        <button class="mini-btn" id="btnShuffle">ÈáçÊéíÂ∫è / Reshuffle</button>
        <button class="mini-btn" id="btnSave">‰øùÂ≠ò / Save</button>
        <button class="mini-btn" id="btnBack">ËøîÂõû‰∏ä‰∏ÄÁ∫ß / Back</button>
        <button class="mini-btn" id="btnWrong">ÈîôËØçÊú¨ / Wrong Book</button>
      </div>
      <div class="finish-overlay" id="finish">
        <div id="finishText" style="font-weight:800; margin-bottom:8px;">Êú¨ÂÖ≥ÂÆåÊàêÔºÅ</div>
        <div>
          <button class="btn" id="btnPrev">ËøîÂõû‰∏ä‰∏ÄÂÖ≥</button>
          <button class="btn" id="btnNext">ÁªßÁª≠‰∏ã‰∏ÄÂÖ≥</button>
        </div>
      </div>
    </section>

    <section class="stage" id="stage">
      <div class="stage-header">
        <div>
          <div class="module-title" id="modTitle">Ê®°ÂùóÊ†áÈ¢ò</div>
          <div class="subtitle" id="modSub">Module Subtitle</div>
        </div>
        <button class="btn" id="btnBackTop">ËøîÂõû‰∏ªËèúÂçï / Back</button>
      </div>
      <div class="stage-actions">
        <button class="action-btn act-demo" id="actDemo">ËØïÁé©Ê∏∏Êàè<br><small>Demo (Built-in 20)</small></button>
        <button class="action-btn act-import" id="actImport">ÂØºÂÖ•ËØçÂ∫ìÁé©Ê∏∏Êàè<br><small>Import & Play</small></button>
        <input id="fileImport" type="file" accept=".csv,.txt" style="display:none" />
        <button class="action-btn" id="btnClearTrial" style="display:none; --c1:#ff9aa2; --c2:#ff6f91;">Ê∏ÖÈô§ÂØºÂÖ•ËØçÂ∫ì<br><small>Clear Imported Bank</small></button>
      </div>
    </section>

    <footer>
      Copyright Held by: Mr. Yan Qinghua, Chongqing Technology and Business University (CTBU)<br/>
      Support by: Teaching and Research Section of TCFL, CTBU
    </footer>
  </div>

  <dialog id="dlgRegister">
    <form method="dialog" id="formRegister" style="min-width:300px">
      <h3>Ê≥®ÂÜå Register</h3>
      <label>Áî®Êà∑Âêç Username<br/>
        <input id="regName" required maxlength="24" />
      </label><br/><br/>
      <label>ÂØÜÁ†Å Password<br/>
        <input id="regPass" type="password" required minlength="4" />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">ÂèñÊ∂à Cancel</button>
        <button class="btn" value="default">Êèê‰∫§ Submit</button>
      </menu>
    </form>
  </dialog>

  <dialog id="dlgLogin">
    <form method="dialog" id="formLogin" style="min-width:300px">
      <h3>ÁôªÂΩï Login</h3>
      <label>Áî®Êà∑Âêç Username<br/>
        <input id="logName" required />
      </label><br/><br/>
      <label>ÂØÜÁ†Å Password<br/>
        <input id="logPass" type="password" required />
      </label>
      <menu style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
        <button class="btn" value="cancel">ÂèñÊ∂à Cancel</button>
        <button class="btn" value="default">ÁôªÂΩï Login</button>
      </menu>
    </form>
  </dialog>

  <div class="wrongpad" id="wrongPad">
    <h4>ÈîôËØçÊú¨ Wrong Book</h4>
    <div id="wrongList"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button class="mini-btn" id="wrongClose">ÂÖ≥Èó≠ / Close</button>
      <button class="mini-btn" id="wrongClear">Ê∏ÖÁ©∫ / Clear</button>
    </div>
  </div>

  <div id="toastStack"></div>
    /* Shim */
    (function(){
      if(typeof window.Intercom!=="function"){
        const q=[]; const shim=function(){ q.push(arguments); };
        shim.q=q; shim.boot=function(){}; shim.shutdown=shim.show=shim.hide=shim.update=function(){};
        window.Intercom=shim;
      }
      window.notifyNavigation = window.notifyNavigation || function(){};
      window.notifyIntrinsicHeight = window.notifyIntrinsicHeight || function(){};
      window.__hostApi = window.__hostApi || {};
      ["notifyNavigation","notifyIntrinsicHeight"].forEach(k=>{
        if(typeof window.__hostApi[k]!=="function") window.__hostApi[k]=function(){};
      });
      window.addEventListener("unhandledrejection", function(e){
        const msg = (e && e.reason && (e.reason.stack||e.reason.message||e.reason)) || "";
        if(String(msg).match(/Intercom|Host API|notifyNavigation|notifyIntrinsicHeight/)) e.preventDefault();
      });
    })();

    const $ = (q)=>document.querySelector(q);

    /* ===== Users & Trial store ===== */
    const store = {
      get users(){ return JSON.parse(localStorage.getItem('hsk_users')||'{}'); },
      set users(v){ localStorage.setItem('hsk_users', JSON.stringify(v)); },
      get session(){ return JSON.parse(localStorage.getItem('hsk_session')||'null'); },
      set session(v){ localStorage.setItem('hsk_session', JSON.stringify(v)); },
      get trial(){ return JSON.parse(localStorage.getItem('dev_trial_words')||'null'); },
      set trial(v){ localStorage.setItem('dev_trial_words', JSON.stringify(v)); }
    };

    const btnRegister = $('#btnRegister');
    const btnLogin = $('#btnLogin');
    const dlgRegister = $('#dlgRegister');
    const dlgLogin = $('#dlgLogin');

    function safeShowModal(d){
      if(!d.open){ try{ d.showModal(); }catch{ d.setAttribute('open',''); } }
    }
    function safeClose(d){
      if(d.open){ try{ d.close(); }catch{ d.removeAttribute('open'); } }
    }

    function refreshAuthUI(){
      const s = store.session;
      if(s && s.username){
        btnRegister.textContent = 'üëã Ê¨¢Ëøé ' + s.username;
        btnRegister.disabled = true;
        btnLogin.textContent = 'ÈÄÄÂá∫ Logout';
      }else{
        btnRegister.textContent = 'Ê≥®ÂÜå Register';
        btnRegister.disabled = false;
        btnLogin.textContent = 'ÁôªÂΩï Login';
      }
    }

    btnRegister.addEventListener('click', ()=>{ if(!store.session) safeShowModal(dlgRegister); });
    btnLogin.addEventListener('click', ()=>{
      if(store.session){ store.session = null; refreshAuthUI(); showToast('Â∑≤ÈÄÄÂá∫ / Logged out','success'); return; }
      safeShowModal(dlgLogin);
    });

    document.getElementById('formRegister').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#regName').value.trim();
      const pass = $('#regPass').value;
      if(!name || !pass) return;
      const users = store.users;
      if(users[name]){ showToast('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú® / Username exists','error'); return; }
      users[name] = { password: pass };
      store.users = users;
      store.session = { username: name };
      safeClose(dlgRegister); refreshAuthUI();
      showToast('Ê≥®ÂÜåÊàêÂäüÔºåÂ∑≤Ëá™Âä®ÁôªÂΩï / Registered & Signed in','success');
    });

    document.getElementById('formLogin').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#logName').value.trim();
      const pass = $('#logPass').value;
      const users = store.users;
      if(!users[name] || users[name].password !== pass){ showToast('Áî®Êà∑ÊàñÂØÜÁ†ÅÈîôËØØ / Invalid credentials','error'); return; }
      store.session = { username: name };
      safeClose(dlgLogin); refreshAuthUI();
      showToast('ÁôªÂΩïÊàêÂäü / Signed in','success');
    });

    refreshAuthUI();

    /* ===== Audio ===== */
    const soundSwitch = document.getElementById('soundSwitch');
    const volume = document.getElementById('volume');
    let audioCtx, masterGain, isOn = true;

    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volume.value || 0.6);
        masterGain.connect(audioCtx.destination);
      }
      if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function applySwitchUI(){ soundSwitch.classList.toggle('on', isOn); soundSwitch.setAttribute('aria-checked', String(isOn)); }
    function toggleSound(){ isOn = !isOn; applySwitchUI(); }
    applySwitchUI();

    soundSwitch.addEventListener('click', ()=>{ ensureAudio(); toggleSound(); });
    soundSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); ensureAudio(); toggleSound(); } });
    volume.addEventListener('input', ()=>{ ensureAudio(); if(masterGain) masterGain.gain.value = Number(volume.value||0.6); });

    function playSfx(type='click'){
      if(!isOn) return;
      ensureAudio();
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = (type==='err') ? 'square' : 'sine';
      const cfg = {
        click: { f: 660, dur: 0.08 },
        ok:    { f: 880, dur: 0.14 },
        err:   { f: 180, dur: 0.18 },
        done:  { f: 520, dur: 0.24 },
        shuffle:{ f: 740, dur: 0.10 }
      }[type] || { f: 660, dur: 0.08 };
      osc.frequency.setValueAtTime(cfg.f, now);
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + cfg.dur);
      osc.connect(gain).connect(masterGain);
      osc.start(now);
      osc.stop(now + cfg.dur + 0.02);
    }

    /* ===== Module Nav ===== */
    const menu = document.getElementById('menu');
    const stage = document.getElementById('stage');
    const modTitle = document.getElementById('modTitle');
    const modSub = document.getElementById('modSub');
    const btnBackTop = document.getElementById('btnBackTop');
    const actDemo = document.getElementById('actDemo');
    const actImport = document.getElementById('actImport');
    const fileImport = document.getElementById('fileImport');
    const btnClearTrial = document.getElementById('btnClearTrial');

    function openModule(key, titleCN, titleEN){
      modTitle.textContent = titleCN;
      modSub.textContent = titleEN;
      menu.style.display = 'none';
      stage.style.display = 'block';
      showToast('ËøõÂÖ•Ê®°ÂùóÔºö' + titleCN, 'success');
      stage.dataset.key = key;
      btnClearTrial.style.display = store.trial ? 'inline-block':'none';
    }
    function backHome(){ stage.style.display='none'; menu.style.display='grid'; }

    document.querySelectorAll('#menu .card').forEach(c=>{
      c.addEventListener('mousemove',(e)=>{
        const r = c.getBoundingClientRect();
        const x = ((e.clientX - r.left)/r.width)*100;
        const y = ((e.clientY - r.top)/r.height)*100;
        c.style.setProperty('--mx', x+'%');
        c.style.setProperty('--my', y+'%');
      });
      c.addEventListener('click', ()=>{
        const key = c.getAttribute('data-key');
        if(key==='banks'){ showToast('‚ÄúËé∑ÂèñËØçÂ∫ìÂíåÈ¢òÂ∫ì‚ÄùÈ°µÈù¢Á®çÂêéÊèê‰æõ / Coming soon','info'); return; }
        if(!store.session){ showToast('‰ª•Ê∏∏ÂÆ¢Ê®°ÂºèËøõÂÖ•„ÄÇÂèØÂú®Âè≥‰∏äËßíÊ≥®ÂÜå/ÁôªÂΩï‰ª•‰øùÂ≠òËøõÂ∫¶„ÄÇ','info'); }
        const cn = c.querySelector('.cn').textContent.trim();
        const en = c.querySelector('.en').textContent.trim();
        playSfx('click'); openModule(key, cn, en);
      });
    });

    btnBackTop.addEventListener('click', backHome);

    actDemo.addEventListener('click', ()=>{
      playSfx('click');
      const key = stage.dataset.key;
      if(key === 'dev-cn'){
        stage.style.display='none';
        document.getElementById('gameDemo').style.display='block';
        initDemo(false); // built-in only
        showToast('ÂèëÂ±ïËã±ËØ≠¬∑ËØïÁé©ÔºàÂÜÖÁΩÆ 20 ‰∏™ËØçÔºâÂºÄÂßã','success');
      }else{
        showToast('„Äê'+modTitle.textContent+'„ÄëËØïÁé©Ê®°ÂºèÂêØÂä®ÔºàÂç†‰ΩçÔºâ/ Demo starting‚Ä¶','success');
      }
    });

    actImport.addEventListener('click', ()=>{
      playSfx('click'); fileImport.click();
    });

    fileImport.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = parseTrial(text);
        if(!parsed || !parsed.length){
          showToast('ÂØºÂÖ•Â§±Ë¥•ÔºöÊú™Ëß£ÊûêÂà∞ÊúâÊïàÊù°ÁõÆ„ÄÇ','error'); return;
        }
        const uniq = [];
        const seen = new Set();
        for(const w of parsed){
          const k = (w.cn||'') + '|' + (w.py||'');
          if(!seen.has(k)){ seen.add(k); uniq.push(w); }
          if(uniq.length>=20) break;
        }
        if(uniq.length<5){
          showToast('ÂØºÂÖ•Êù°ÁõÆÂ§™Â∞ëÔºåËá≥Â∞ëÈúÄË¶Å 5 Êù°„ÄÇ','error'); return;
        }
        store.trial = uniq;
        btnClearTrial.style.display = 'inline-block';
        showToast('ÊàêÂäüÂØºÂÖ• ${uniq.length} Êù°„ÄÇËØ•ËØçÂ∫ìÂ∞ÜÁî®‰∫é‚ÄúÂØºÂÖ•ËØçÂ∫ìÁé©Ê∏∏Êàè‚ÄùÊ®°Âºè„ÄÇ','success');
      }catch(err){
        console.error(err);
        showToast('ÂØºÂÖ•Âá∫ÈîôÔºöÊñá‰ª∂ËØªÂèñÊàñËß£ÊûêÂ§±Ë¥•„ÄÇ','error');
      }finally{
        fileImport.value = '';
      }
    });

    btnClearTrial.addEventListener('click', ()=>{
      store.trial = null;
      btnClearTrial.style.display = 'none';
      showToast('Â∑≤Ê∏ÖÈô§ÂØºÂÖ•ËØçÂ∫ì„ÄÇ','success');
    });

    /* ===== Toast ===== */
    function showToast(msg, type='info'){
      const stack = document.getElementById('toastStack') || (()=>{ const d=document.createElement('div'); d.id='toastStack'; Object.assign(d.style,{position:'fixed',left:'50%',top:'16px',transform:'translateX(-50%)',display:'flex',flexDirection:'column',gap:'8px',zIndex:9999}); document.body.appendChild(d); return d; })();
      const el = document.createElement('div'); el.className = 'toast ' + type; el.textContent = msg;
      Object.assign(el.style,{padding:'10px 14px',borderRadius:'10px',background:'#0b1220',color:'#e9f1ff',boxShadow:'0 8px 24px rgba(0,0,0,.35)',opacity:'0.98',transition:'all .4s ease'});
      stack.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-6px)'; }, 3200);
      setTimeout(()=>{ el.remove(); }, 3800);
    }

    /* ===== Built-in Demo Data (your uploaded 20 words) ===== */
    const DEMO_TXT = '‰Ω†,n«ê,you (singular),‡∏Ñ‡∏∏‡∏ì,b·∫°n,‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤,tu/vous,„ÅÇ„Å™„Åü,ÎÑà/ÎãπÏã†,—Ç—ã,du,t√∫
Â•Ω,h«éo,good/fine/nice,‡∏î‡∏µ,t·ªët,‡∫î‡∫µ,bon,„ÅÑ„ÅÑ,Ï¢ãÏùÄ,—Ö–æ—Ä–æ—à–∏–π,gut,bueno
‰Ω†‰ª¨,n«ê men,you (plural),‡∏û‡∏ß‡∏Å‡∏Ñ‡∏∏‡∏ì,c√°c b·∫°n,‡∫û‡∫ß‡∫Å‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤,vous,„ÅÇ„Å™„Åü„Åü„Å°,ÎÑàÌù¨/ÎãπÏã†Îì§,–≤—ã,ihr,vosotros/ustedes
ËÄÅÂ∏à,l«éo shƒ´,teacher,‡∏Ñ‡∏£‡∏π,gi√°o vi√™n,‡∫Ñ‡∫π,professeur/enseignant,ÂÖàÁîü,ÏÑ†ÏÉùÎãò,—É—á–∏—Ç–µ–ª—å,Lehrer,profesor/maestro
Êó©‰∏ä,z«éo shang,morning/early morning,‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤,bu·ªïi s√°ng,‡∫ï‡∫≠‡∫ô‡ªÄ‡∫ä‡∫ª‡ªâ‡∫≤,matin,Êúù,ÏïÑÏπ®,—É—Ç—Ä–æ,Morgen,ma√±ana
ÊòØ,sh√¨,be,‡∏Ñ‡∏∑‡∏≠,l√†,‡ªÅ‡∫°‡ªà‡∫ô,√™tre,„Åß„Åô,Ïù¥Îã§,–±—ã—Ç—å,sein,ser/estar
ÂõΩ,gu√≥,country/state/nation,‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡∏ä‡∏≤‡∏ï‡∏¥,qu·ªëc gia,‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î,pays/√©tat/nation,ÂõΩ,ÎÇòÎùº/Íµ≠Í∞Ä,—Å—Ç—Ä–∞–Ω–∞/–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ,Land/Staat/Nation,pa√≠s/estado/naci√≥n
‰∫∫,r√©n,people/human being,‡∏Ñ‡∏ô,ng∆∞·ªùi,‡∫Ñ‡∫ª‡∫ô,personne/humain,‰∫∫,ÏÇ¨Îûå,—á–µ–ª–æ–≤–µ–∫/–ª—é–¥–∏,Mensch/Person,persona/humano
Êàë,w«í,I/me,‡∏â‡∏±‡∏ô,t√¥i,‡∫Ç‡ªâ‡∫≠‡∫ç,je/moi,ÁßÅ,ÎÇò/Ï†Ä,—è,ich,yo
‰ªñ,tƒÅ,he/him,‡πÄ‡∏Ç‡∏≤,anh ·∫•y,‡∫•‡∫≤‡∫ß,il/lui,ÂΩº,Í∑∏,–æ–Ω,er,√©l
ËØ∑ÈóÆ,q«êng w√®n,excuse me/may I ask,‡∏Ç‡∏≠‡∏ñ‡∏≤‡∏°,xin h·ªèi,‡∫Ç‡ªç‡∫ñ‡∫≤‡∫°,excusez-moi/puis-je demander,„Åô„Åø„Åæ„Åõ„Çì,Ïã§Î°ÄÌï©ÎãàÎã§/Ïó¨Ï≠§Î≥¥Í≤†ÏäµÎãàÎã§,–∏–∑–≤–∏–Ω–∏—Ç–µ/–º–æ–≥—É —è —Å–ø—Ä–æ—Å–∏—Ç—å,entschuldigen Sie/darf ich fragen,disculpe/¬øpuedo preguntar?
‰ªÄ‰πà,sh√©n me,what,‡∏≠‡∏∞‡πÑ‡∏£,g√¨,‡∫´‡∫ç‡∫±‡∫á,quoi/que,‰Ωï,Î¨¥Ïóá/Î≠ê,—á—Ç–æ,was,qu√©
ÂêçÂ≠ó,m√≠ng zi,name/given or personal name,‡∏ä‡∏∑‡πà‡∏≠,t√™n,‡∫ä‡∫∑‡ªà,nom,ÂêçÂâç,Ïù¥Î¶Ñ,–∏–º—è,Name,nombre
Âßì,x√¨ng,be surnamed,‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,h·ªç,‡∫ä‡∫∑‡ªà‡∫™‡∫∞‡∫Å‡∫∏‡∫ô,nom de famille,ËãóÂ≠ó/Âßì,ÏÑ±,—Ñ–∞–º–∏–ª–∏—è,Nachname,apellido
È´òÂÖ¥,gƒÅo x√¨ng,glad/happy,‡∏î‡∏µ‡πÉ‡∏à,vui m·ª´ng,‡∫î‡∫µ‡ªÉ‡∫à,content/heureux,Â¨â„Åó„ÅÑ,Í∏∞ÏÅú,—Ä–∞–¥/—Å—á–∞—Å—Ç–ª–∏–≤—ã–π,froh/gl√ºcklich,contento/feliz
Â§ßÂ≠¶Áîü,d√† xu√© shƒìng,college or university student,‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤,sinh vi√™n ƒë·∫°i h·ªçc,‡∫ô‡∫±‡∫Å‡∫™‡∫∂‡∫Å‡∫™‡∫≤‡∫°‡∫∞‡∫´‡∫≤‡∫ß‡∫¥‡∫ó‡∫∞‡∫ç‡∫≤‡ªÑ‡∫•,√©tudiant universitaire,Â§ßÂ≠¶Áîü,ÎåÄÌïôÏÉù,—Å—Ç—É–¥–µ–Ω—Ç —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞,Universit√§tsstudent,estudiante universitario
Âá†,j«ê,how many,‡∏Å‡∏µ‡πà,m·∫•y,‡∫Å‡∫µ‡ªà,combien,„ÅÑ„Åè„Å§,Î™á,—Å–∫–æ–ª—å–∫–æ,wie viele,cu√°ntos
Â∑•‰Ωú,g≈çng zu√≤,job/work/task,‡∏á‡∏≤‡∏ô,c√¥ng vi·ªác,‡∫ß‡∫Ω‡∫Å,travail/emploi,‰ªï‰∫ã,Ïùº/ÏûëÏóÖ,—Ä–∞–±–æ—Ç–∞,Arbeit/Job,trabajo/empleo
ÂæãÂ∏à,l«ú shƒ´,lawyer/attorney,‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°,lu·∫≠t s∆∞,‡∫ó‡∫∞‡∫ô‡∫≤‡∫ç‡∫Ñ‡∫ß‡∫≤‡∫°,avocat,ÂºÅË≠∑Â£´,Î≥ÄÌò∏ÏÇ¨,–∞–¥–≤–æ–∫–∞—Ç,Anwalt,abogado
ÂåªÁîü,yƒ´s hƒìng,doctor/medical practitioner,‡∏´‡∏°‡∏≠/‡πÅ‡∏û‡∏ó‡∏¢‡πå,b√°c sƒ©,‡∫´‡∫°‡ªç/‡ªÅ‡∫û‡∫î,m√©decin/docteur,ÂåªËÄÖ,ÏùòÏÇ¨,–≤—Ä–∞—á/–¥–æ–∫—Ç–æ—Ä,Arzt,m√©dico/doctor';

    
    function parseDemo(txt){
      if(!txt) return [];
      // Normalize
      txt = txt.replace(/\uFEFF/g, '');               // BOM
      txt = txt.replace(/Ôºå|Ôºõ|;/g, ',');              // CN comma/semicolon -> comma
      txt = txt.replace(/\t/g, ',');                  // tabs -> comma
      txt = txt.replace(/\r\n?/g, '\n');              // CRLF/LF -> LF
      txt = txt.replace(/\n{2,}/g, '\n');             // collapse blank lines
      const lines0 = txt.split(/\n/).map(s=>s.trim()).filter(Boolean);
      // Drop header if present
      const hasHeader = lines0.length && /(‰∏≠Êñá|Ê±âÂ≠ó|chinese|ÊãºÈü≥|pinyin|Ëã±ËØ≠|english|en)\b/i.test(lines0[0]);
      const lines = hasHeader ? lines0.slice(1) : lines0;
      const out = [];
      for(const line of lines){
        // split on commas; keep empties
        const parts = line.split(',').map(s=>s.trim());
        if(parts.length < 3) continue;                         // need cn/py/en
        while(parts.length < 12) parts.push('');               // pad
        const [cn, py, en] = parts;
        if(!cn || !py || !en) continue;                        // require first 3
        for(let i=3;i<12;i++){ if(!parts[i]) parts[i]=en; }    // fallback to English
        const [th,vi,lo,fr,ja,ko,ru,de,es] = parts.slice(3,12);
        out.push([cn, py, [en, th, vi, lo, fr, ja, ko, ru, de, es]]);
      }
      return out;
    }


    const demoDataFull = parseDemo(DEMO_TXT);
    const BUILTIN_LIMIT = 20;
    const demoData = demoDataFull.slice(0, BUILTIN_LIMIT); // exactly 20

    // Language list (default English)
    const LANGS = [
      {code:'en', name:'Ëã±ËØ≠ English',     idx:0, color:'#ffffff'},
      {code:'th', name:'Ê≥∞ËØ≠ Thai',        idx:1, color:'#ffd37a'},
      {code:'vi', name:'Ë∂äÂçóËØ≠ Vietnamese',idx:2, color:'#7afcff'},
      {code:'lo', name:'ËÄÅÊåùËØ≠ Lao',       idx:3, color:'#8ec5ff'},
      {code:'fr', name:'Ê≥ïËØ≠ Fran√ßais',    idx:4, color:'#d6b7ff'},
      {code:'ja', name:'Êó•ËØ≠ Êó•Êú¨Ë™û',      idx:5, color:'#ff91a9'},
      {code:'ko', name:'Èü©ËØ≠ ÌïúÍµ≠Ïñ¥',      idx:6, color:'#9dffa8'},
      {code:'ru', name:'‰øÑËØ≠ –†—É—Å—Å–∫–∏–π',     idx:7, color:'#ffc7a5'},
      {code:'de', name:'Âæ∑ËØ≠ Deutsch',     idx:8, color:'#c6ffef'},
      {code:'es', name:'Ë•øÁè≠ÁâôËØ≠ Espa√±ol', idx:9, color:'#fdd8ff'}
    ];

    function parseTrial(text){
      const rows = text.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
      if(!rows.length) return [];
      const header = rows[0].split(/[,\t]/).map(s=>s.trim().toLowerCase());
      const hasHeader = header.some(h=>/‰∏≠Êñá|Ê±âÂ≠ó|cn|ÊãºÈü≥|pinyin|Ëã±ËØ≠|english|en/.test(h));
      const lines = hasHeader ? rows.slice(1) : rows;
      let idx = { cn:0, py:1, en:2, th:-1, vi:-1, lo:-1, fr:-1, ja:-1, ko:-1, ru:-1, de:-1, es:-1 };
      if(hasHeader){
        const map = {cn:['‰∏≠Êñá','Ê±âÂ≠ó','chinese','cn'], py:['ÊãºÈü≥','pinyin','py'], en:['Ëã±ËØ≠','english','en'], th:['Ê≥∞','thai','th'], vi:['Ë∂ä','viet','vi'], lo:['ËÄÅÊåù','lao','lo'], fr:['Ê≥ï','fran√ßais','fr'], ja:['Êó•','japanese','ja'], ko:['Èü©','korean','ko'], ru:['‰øÑ','russian','ru'], de:['Âæ∑','german','de'], es:['Ë•ø','spanish','es']};
        Object.keys(map).forEach(k=>{
          for(const key of map[k]){
            const i = header.findIndex(h=>h.includes(key));
            if(i>=0){ idx[k]=i; break; }
          }
        });
      }
      const out = [];
      for(const line of lines){
        const p = line.split(/[,\t]/).map(s=>s.trim());
        const cn = p[idx.cn]||p[0]||'';
        const py = p[idx.py]||p[1]||'';
        const en = p[idx.en]||p[2]||'';
        if(!cn || !py || !en) continue;
        const langs = [en,
          idx.th>=0?(p[idx.th]||''):en, idx.vi>=0?(p[idx.vi]||''):en, idx.lo>=0?(p[idx.lo]||''):en,
          idx.fr>=0?(p[idx.fr]||''):en, idx.ja>=0?(p[idx.ja]||''):en, idx.ko>=0?(p[idx.ko]||''):en,
          idx.ru>=0?(p[idx.ru]||''):en, idx.de>=0?(p[idx.de]||''):en, idx.es>=0?(p[idx.es]||''):en
        ];
        out.push({cn, py, langs});
      }
      return out;
    }

    let state = {
      level: 1,
      passed: Number(localStorage.getItem('dev_demo_passed')||0),
      total: demoData.length, // 20
      langIdx: 0, // default English
      choice: { cn:null, py:null, tr:null },
      tiles: { cn:[], py:[], tr:[] ,
        congrats: "¬°Enhorabuena por completar la demo!"
    },
      mapping: {},
      wrongBook: JSON.parse(localStorage.getItem('dev_demo_wrong')||'[]'),
      matchedCount: 0,
      usingTrial: false,
      trialWords: []
    };

    function shade(hex, k){
      const c = hex.replace('#','');
      const r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
      const rr = Math.round(r*k+255*(1-k)), gg = Math.round(g*k+255*(1-k)), bb = Math.round(b*k+255*(1-k));
      return 'rgb(${rr},${gg},${bb})';
    }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=a[i]; a[i]=a[j]; a[j]=t; } return a; }

    function buildLangRow(){
      const row = document.getElementById('langRow');
      row.innerHTML = '';
      LANGS.forEach(L=>{
        const b = document.createElement('button');
        b.className = 'lang-btn';
        b.style.backgroundImage = 'linear-gradient(180deg,#fff,${shade(L.color,0.9)})';
        b.textContent = L.name;
        if(L.idx===state.langIdx) b.classList.add('active');
        b.addEventListener('click', ()=>{
          state.langIdx = L.idx;
          document.querySelectorAll('.lang-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active');
          updateTransTexts();
        });
        row.appendChild(b);
      });
      row.addEventListener('pointerdown', ()=> ensureAudio(), { once:true });
    }

    function initDemo(useTrial=false){
      state.usingTrial = !!useTrial;
      state.level = 1;
      document.getElementById('total').textContent = state.total;
      document.getElementById('passed').textContent = state.passed;
      document.getElementById('levelInfo').innerHTML = 'ÂÖ≥Âç°Ôºö<strong>'+state.level+'</strong>';
      buildLangRow();
      if(useTrial){
        const tw = store.trial || [];
        state.trialWords = tw.map((w,i)=>({ id:i, cn:w.cn, py:w.py, langs:w.langs }));
        makeRoundTrial();
      }else{
        makeRoundBuiltin(); // built-in 4 groups of 5
      }
    }

    function makeRoundBuiltin(){
      const N = 5;
      const MAX_LEVELS = 4;
      if(state.level>MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, 'ËØïÁé©ÂçïËØçÂ∑≤Áî®ÂÆåÔºàÂÜÖÁΩÆ 20 ‰∏™Ôºå4 ÂÖ≥Ôºâ„ÄÇ');
        return;
      }
      const start = (state.level-1)*N; // fixed partition
      const slice = demoData.slice(start, start+N);
      const words = slice.map((w, idx)=>{
        const id = start+idx; // 0..19 stable id
        return { id, cn: w[0], py: w[1], tr: w[2][state.langIdx] };
      });
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      renderBoard();
    }

    function makeRoundTrial(){
      const N = 5;
      const MAX_LEVELS = Math.min(4, Math.ceil(state.trialWords.length / N));
      if(state.level > MAX_LEVELS){
        renderBoardEmpty();
        updateOverlay(true, 'ÂØºÂÖ•ËØïÁé©ÂçïËØçÂ∑≤Áî®ÂÆå„ÄÇ');
        return;
      }
      const start = (state.level-1)*N;
      const slice = state.trialWords.slice(start, start+N);
      const words = slice.map((w)=>({ id:w.id, cn:w.cn, py:w.py, tr:(w.langs[state.langIdx]||w.langs[0]) }));
      state.mapping = words.reduce((acc,w)=>{ acc[w.id]=w; return acc; },{});
      state.tiles.cn = shuffle(words.map(w=>({id:w.id, text:w.cn})));
      state.tiles.py = shuffle(words.map(w=>({id:w.id, text:w.py})));
      state.tiles.tr = shuffle(words.map(w=>({id:w.id, text:w.tr})));
      state.matchedCount = 0;
      renderBoard();
    }

    function renderBoard(){
      const cn = document.getElementById('colCN');
      const py = document.getElementById('colPY');
      const tr = document.getElementById('colTR');
      cn.innerHTML = py.innerHTML = tr.innerHTML = '';
      ['cn','py','tr'].forEach(kind=>{
        const col = kind==='cn'?cn:kind==='py'?py:tr;
        state.tiles[kind].forEach(t=>{
          const el = document.createElement('div');
          el.className = 'tile'; el.textContent = t.text; el.dataset.id = t.id; el.dataset.kind = kind;
          el.addEventListener('click', ()=>onPick(el));
          col.appendChild(el);
        });
      });
      updateOverlay(false, 'Êú¨ÂÖ≥ÂÆåÊàêÔºÅ');
      state.choice = {cn:null,py:null,tr:null};
    }

    function renderBoardEmpty(){
      ['colCN','colPY','colTR'].forEach(id=>{ document.getElementById(id).innerHTML=''; });
    }

    function updateTransTexts(){
      const trCol = document.getElementById('colTR');
      trCol.querySelectorAll('.tile').forEach(node=>{
        const id = Number(node.dataset.id);
        let text;
        if(state.usingTrial){
          const w = state.trialWords[id];
          text = (w && w.langs[state.langIdx]) || (w && w.langs[0]) || '';
        }else{
          const w = demoData[id];
          text = w ? w[2][state.langIdx] : '';
        }
        node.textContent = text;
      });
      state.tiles.tr = Array.from(trCol.querySelectorAll('.tile')).map(n=>({id:Number(n.dataset.id), text:n.textContent}));
    }

    function onPick(el){
      const kind = el.dataset.kind; const id = Number(el.dataset.id);
      if(el.classList.contains('selected')){ el.classList.remove('selected'); state.choice[kind]=null; return; }
      document.querySelectorAll('.tile[data-kind="${kind}"]').forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected'); state.choice[kind]=id;
      const {cn,py,tr} = state.choice;
      if(cn!==null && py!==null && tr!==null){
        const ok = (cn===py && py===tr);
        if(ok){
          playSfx('ok');
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector('.tile[data-kind="${k}"][data-id="${state.choice[k]}"]');
            if(node){ node.classList.add('correct'); setTimeout(()=>node.remove(), 600); }
          });
          state.matchedCount += 1;
          const targetCount = 5;
          if(state.matchedCount>=targetCount){
            state.passed += 1;
            localStorage.setItem('dev_demo_passed', state.passed);
            document.getElementById('passed').textContent = state.passed;
            setTimeout(()=>{ updateOverlay(true, 'Êú¨ÂÖ≥ÂÆåÊàêÔºÅ'); playSfx('done'); }, 650);
          }
          state.choice = {cn:null,py:null,tr:null};
        }else{
          ['cn','py','tr'].forEach(k=>{
            const node = document.querySelector('.tile[data-kind="${k}"][data-id="${state.choice[k]}"]');
            if(node){ node.classList.add('wrong'); setTimeout(()=>node.classList.remove('wrong'), 260); }
          });
          playSfx('err');
          const anyId = cn ?? py ?? tr;
          if(Number.isFinite(anyId)){
            let wcn='', wpy='', wtr='';
            if(state.usingTrial){
              const w = state.trialWords[anyId]; if(w){ wcn=w.cn; wpy=w.py; wtr=w.langs[state.langIdx]||w.langs[0]; }
            }else{
              const w = demoData[anyId]; if(w){ wcn=w[0]; wpy=w[1]; wtr=w[2][state.langIdx]; }
            }
            if(wcn && wpy && wtr){
              const book = state.wrongBook || [];
              book.push({cn:wcn, py:wpy, tr:wtr, lang:state.langIdx});
              state.wrongBook = book;
              localStorage.setItem('dev_demo_wrong', JSON.stringify(book));
            }
          }
          showToast('ÈÖçÂØπ‰∏çÊ≠£Á°ÆÔºåËØ∑ÈáçËØï / Not a match','error');
        }
      }
    }

    function updateOverlay(show, text){
      const f = document.getElementById('finish');
      const t = document.getElementById('finishText');
      if(typeof text==='string') t.textContent = text;
      f.style.display = show? 'flex':'none';
    }

    // Bottom buttons
    document.getElementById('btnTip').addEventListener('click', ()=>{
      playSfx('click'); showToast('ÊèêÁ§∫ÔºöÂÖàËßÇÂØüÊãºÈü≥ÁªìÊûÑÔºåÂÜçÁÇπÈÄâ‰∏≠Êñá‚ÜíÊãºÈü≥‚ÜíÁøªËØë„ÄÇ','info');
    });
    document.getElementById('btnShuffle').addEventListener('click', ()=>{
      playSfx('shuffle'); ['cn','py','tr'].forEach(k=>{ state.tiles[k]=state.tiles[k].sort(()=>Math.random()-0.5); });
      renderBoard();
    });
    document.getElementById('btnSave').addEventListener('click', ()=>{
      localStorage.setItem('dev_demo_wrong', JSON.stringify(state.wrongBook));
      localStorage.setItem('dev_demo_passed', state.passed);
      playSfx('click'); showToast('ËøõÂ∫¶Â∑≤‰øùÂ≠ò / Progress saved','success');
    });
    document.getElementById('btnBack').addEventListener('click', ()=>{
      playSfx('click');
      document.getElementById('gameDemo').style.display='none';
      stage.style.display='block';
    });

    document.getElementById('btnPrev').addEventListener('click', ()=>{
      if(state.level>1){ state.level--; }
      document.getElementById('levelInfo').innerHTML = 'ÂÖ≥Âç°Ôºö<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, 'Êú¨ÂÖ≥ÂÆåÊàêÔºÅ');
    });
    document.getElementById('btnNext').addEventListener('click', ()=>{
      state.level++;
      document.getElementById('levelInfo').innerHTML = 'ÂÖ≥Âç°Ôºö<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, 'Êú¨ÂÖ≥ÂÆåÊàêÔºÅ');
      if(!state.usingTrial && state.level>4){ showToast('ÂÜÖÁΩÆËØïÁé©‰ªÖ 4 ÂÖ≥ÔºåÂÖ± 20 ‰∏™ËØç„ÄÇ','info'); }
    });

    document.getElementById('jumpGo').addEventListener('click', ()=>{
      const v = parseInt(document.getElementById('jumpInput').value||'1',10);
      state.level = Math.max(1, Math.min(4, v)); // bound to 1..4 for built-in demo
      document.getElementById('levelInfo').innerHTML = 'ÂÖ≥Âç°Ôºö<strong>'+state.level+'</strong>';
      if(state.usingTrial){ makeRoundTrial(); } else { makeRoundBuiltin(); }
      updateOverlay(false, 'Êú¨ÂÖ≥ÂÆåÊàêÔºÅ');
    });

    // Wrong book
    const wrongPad = document.getElementById('wrongPad');
    document.getElementById('btnWrong').addEventListener('click', ()=>{ renderWrong(); wrongPad.style.display='block'; });
    document.getElementById('wrongClose').addEventListener('click', ()=> wrongPad.style.display='none');
    document.getElementById('wrongClear').addEventListener('click', ()=>{ state.wrongBook=[]; localStorage.setItem('dev_demo_wrong','[]'); renderWrong(); });

    function renderWrong(){
      const list = document.getElementById('wrongList');
      list.innerHTML = '';
      if(!state.wrongBook.length){
        list.innerHTML = '<div class="witem">ÊöÇÊó†ËÆ∞ÂΩï / Empty</div>';
        return;
      }
      state.wrongBook.slice().reverse().forEach((it)=>{
        const d = document.createElement('div');
        d.className = 'witem';
        d.textContent = it.cn + ' ÔΩú ' + it.py + ' ÔΩú ' + it.tr;
        list.appendChild(d);
      });
    }
  
  <script>
    // ===== Localization (Chinese + selected language) =====
    // Order of LANGS corresponds to UI_LANGS below (idx 0..9)
    const UI_LANGS = {
      en: {
        tips: "Tips", reshuffle: "Reshuffle", save: "Save", back: "Back",
        wrongbook: "Wrong Book", backMenu: "Back to Menu", next: "Next",
        prev: "Previous", level: "Level", progress: "Progress",
        jumpTo: "Jump to", levelUnit: "Level", go: "Go",
        hintText: (cn,py,tr) => 'Hint: ‚Äú${cn,
        congrats: "Congratulations on completing the demo!"
    } ‚Äì ${py} ‚Äì ${tr}‚Äù is a correct match.',
        demoOverTitle: "Demo Completed",
        demoOverBody: "If you want to continue, please go to ‚ÄúImport & Play‚Äù.",
        importPlay: "Import & Play",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      th: {
        tips: "‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö", reshuffle: "‡∏™‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà", save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", back: "‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö",
        wrongbook: "‡∏™‡∏°‡∏∏‡∏î‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î", backMenu: "‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π", next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
        prev: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤", level: "‡∏î‡πà‡∏≤‡∏ô", progress: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤",
        jumpTo: "‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏î‡πà‡∏≤‡∏ô", levelUnit: "‡∏î‡πà‡∏≤‡∏ô", go: "‡∏ï‡∏Å‡∏•‡∏á",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô",
        demoOverBody: "‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠ ‡πÇ‡∏õ‡∏£‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà ‚Äú‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‚Äù",
        importPlay: "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ & ‡πÄ‡∏•‡πà‡∏ô",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      vi: {
        tips: "G·ª£i √Ω", reshuffle: "X√°o l·∫°i", save: "L∆∞u", back: "Quay l·∫°i",
        wrongbook: "S·ªï t·ª´ sai", backMenu: "V·ªÅ menu", next: "Ti·∫øp",
        prev: "Tr∆∞·ªõc", level: "C·∫•p", progress: "Ti·∫øn ƒë·ªô",
        jumpTo: "Nh·∫£y ƒë·∫øn", levelUnit: "C·∫•p", go: "ƒêi",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "K·∫øt th√∫c b·∫£n ch∆°i th·ª≠",
        demoOverBody: "Mu·ªën ch∆°i ti·∫øp, h√£y ƒë·∫øn ‚ÄúNh·∫≠p t·ª´ & ch∆°i‚Äù.",
        importPlay: "Nh·∫≠p & Ch∆°i",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      lo: {
        tips: "‡ªÅ‡∫ô‡∫∞‡∫ô‡ªç‡∫≤", reshuffle: "‡∫™‡∫±‡∫ö‡ªÉ‡ªù‡ªà", save: "‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å", back: "‡∫Å‡∫±‡∫ö",
        wrongbook: "‡∫™‡∫ª‡∫î‡∫Ñ‡∫≥‡∫ú‡∫¥‡∫î", backMenu: "‡∫Å‡∫±‡∫ö‡ªÄ‡∫°‡∫ô‡∫π", next: "‡∫ï‡ªç‡ªà‡ªÑ‡∫õ",
        prev: "‡∫Å‡ªà‡∫≠‡∫ô‡ªú‡ªâ‡∫≤", level: "‡∫î‡ªà‡∫≤‡∫ô", progress: "‡∫Ñ‡∫ß‡∫≤‡∫°‡∫Ñ‡∫∑‡∫ö‡ªú‡ªâ‡∫≤",
        jumpTo: "‡ªÑ‡∫õ‡∫ó‡∫µ‡ªà", levelUnit: "‡∫î‡ªà‡∫≤‡∫ô", go: "Go",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "‡∫™‡∫¥‡ªâ‡∫ô‡∫™‡∫∏‡∫î‡∫Å‡∫≤‡∫ô‡∫ó‡∫ª‡∫î‡∫•‡∫≠‡∫á",
        demoOverBody: "‡∫ñ‡ªâ‡∫≤‡∫¢‡∫≤‡∫Å‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫ï‡ªç‡ªà ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÑ‡∫õ ‚Äú‡∫ô‡ªç‡∫≤‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤ & ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‚Äù",
        importPlay: "‡∫ô‡ªç‡∫≤‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤ & ‡∫´‡∫º‡∫¥‡ªâ‡∫ô",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      fr: {
        tips: "Astuce", reshuffle: "M√©langer", save: "Enregistrer", back: "Retour",
        wrongbook: "Fautes", backMenu: "Retour au menu", next: "Suivant",
        prev: "Pr√©c√©dent", level: "Niveau", progress: "Progr√®s",
        jumpTo: "Aller au", levelUnit: "niveau", go: "Aller",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "D√©mo termin√©e",
        demoOverBody: "Pour continuer, allez √† ¬´¬†Importer & Jouer¬†¬ª.",
        importPlay: "Importer & Jouer",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      ja: {
        tips: "„Éí„É≥„Éà", reshuffle: "„Ç∑„É£„ÉÉ„Éï„É´", save: "‰øùÂ≠ò", back: "Êàª„Çã",
        wrongbook: "ÈñìÈÅï„ÅÑÂ∏≥", backMenu: "„É°„Éã„É•„Éº„Å∏Êàª„Çã", next: "Ê¨°„Å∏",
        prev: "Ââç„Å∏", level: "„É¨„Éô„É´", progress: "ÈÄ≤Êçó",
        jumpTo: "ÁßªÂãïÂÖà", levelUnit: "„É¨„Éô„É´", go: "Go",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "‰ΩìÈ®ìÁâà„ÅØÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü",
        demoOverBody: "Á∂ö„Åë„Çã„Å´„ÅØ„Äå„Ç§„É≥„Éù„Éº„Éà„Åó„Å¶„Éó„É¨„Ç§„Äç„Å∏„ÄÇ",
        importPlay: "„Ç§„É≥„Éù„Éº„Éà„Åó„Å¶„Éó„É¨„Ç§",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      ko: {
        tips: "ÌûåÌä∏", reshuffle: "ÏÑûÍ∏∞", save: "Ï†ÄÏû•", back: "Îí§Î°ú",
        wrongbook: "Ïò§ÎãµÎÖ∏Ìä∏", backMenu: "Î©îÎâ¥Î°ú", next: "Îã§Ïùå",
        prev: "Ïù¥Ï†Ñ", level: "Î†àÎ≤®", progress: "ÏßÑÌñâ",
        jumpTo: "Ïù¥Îèô", levelUnit: "Î†àÎ≤®", go: "Go",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "Ï≤¥Ìóò Ï¢ÖÎ£å",
        demoOverBody: "Í≥ÑÏÜçÌïòÎ†§Î©¥ ‚ÄòÍ∞ÄÏ†∏Ïò§Í∏∞ & ÌîåÎ†àÏù¥‚ÄôÎ•º Ïù¥Ïö©ÌïòÏÑ∏Ïöî.",
        importPlay: "Í∞ÄÏ†∏Ïò§Í∏∞ & ÌîåÎ†àÏù¥",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      ru: {
        tips: "–ü–æ–¥—Å–∫–∞–∑–∫–∞", reshuffle: "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å", save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", back: "–ù–∞–∑–∞–¥",
        wrongbook: "–û—à–∏–±–∫–∏", backMenu: "–í –º–µ–Ω—é", next: "–î–∞–ª–µ–µ",
        prev: "–ù–∞–∑–∞–¥", level: "–£—Ä–æ–≤–µ–Ω—å", progress: "–ü—Ä–æ–≥—Ä–µ—Å—Å",
        jumpTo: "–ü–µ—Ä–µ–π—Ç–∏ –∫", levelUnit: "—É—Ä.", go: "Go",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "–î–µ–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ",
        demoOverBody: "–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ ¬´–ò–º–ø–æ—Ä—Ç –∏ –∏–≥—Ä–∞¬ª.",
        importPlay: "–ò–º–ø–æ—Ä—Ç –∏ –∏–≥—Ä–∞",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      de: {
        tips: "Tipp", reshuffle: "Neu mischen", save: "Speichern", back: "Zur√ºck",
        wrongbook: "Fehlerheft", backMenu: "Zur√ºck zum Men√º", next: "Weiter",
        prev: "Zur√ºck", level: "Level", progress: "Fortschritt",
        jumpTo: "Springe zu", levelUnit: "Level", go: "Los",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "Demo beendet",
        demoOverBody: "Zum Weiterspielen gehe zu ‚ÄûImportieren & Spielen‚Äú.",
        importPlay: "Importieren & Spielen",
        moduleEnter: (name)=>('Enter module: ' + name)
      },
      es: {
        tips: "Pista", reshuffle: "Barajar", save: "Guardar", back: "Volver",
        wrongbook: "Errores", backMenu: "Volver al men√∫", next: "Siguiente",
        prev: "Anterior", level: "Nivel", progress: "Progreso",
        jumpTo: "Ir a", levelUnit: "nivel", go: "Ir",
        hintText: (cn,py,tr)=>('Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù'),
        demoOverTitle: "Demo finalizada",
        demoOverBody: "Para continuar, ve a ¬´Importar y jugar¬ª.",
        importPlay: "Importar y jugar",
        moduleEnter: (name)=>('Enter module: ' + name)
      }
    };

    function getUILangObj(){
      const code = LANGS.find(L=>L.idx===state.langIdx)?.code || 'en';
      return UI_LANGS[code] || UI_LANGS['en'];
    }

    function setBilingualText(el, zh, key){
      const L = getUILangObj();
      const other = (typeof L[key]==='function') ? '' : (L[key] || '');
      if(el) el.textContent = zh + " / " + other;
    }

    function refreshUITexts(){
      const L = getUILangObj();
      // Top labels
      document.getElementById('levelInfo').innerHTML = 'ÂÖ≥Âç°Ôºö<strong>'+state.level+'</strong> / ' + L.level + ' <strong>'+state.level+'</strong>';
      document.querySelector('.progress').innerHTML = 'ËøõÂ∫¶ <span id="passed">'+state.passed+'</span>/<span id="total">'+state.total+'</span> / ' + L.progress + ' <span>'+state.passed+'</span>/<span>'+state.total+'</span>';
      // Jump widgets
      document.querySelector('.jump label').firstChild.textContent = 'Ë∑≥ÂæÄÁ¨¨ ';
      document.querySelector('.jump label').lastChild.textContent = ' ÂÖ≥';
      document.getElementById('jumpGo').textContent = L.go;

      // Bottom buttons
      setBilingualText(document.getElementById('btnTip'), 'ÊèêÁ§∫', 'tips');
      setBilingualText(document.getElementById('btnShuffle'), 'ÈáçÊéíÂ∫è', 'reshuffle');
      setBilingualText(document.getElementById('btnSave'), '‰øùÂ≠ò', 'save');
      setBilingualText(document.getElementById('btnBack'), 'ËøîÂõû‰∏ä‰∏ÄÁ∫ß', 'back');
      setBilingualText(document.getElementById('btnWrong'), 'ÈîôËØçÊú¨', 'wrongbook');

      // Stage buttons
      setBilingualText(document.getElementById('btnBackTop'), 'ËøîÂõû‰∏ªËèúÂçï', 'backMenu');
      document.getElementById('actImport').innerHTML = 'ÂØºÂÖ•ËØçÂ∫ìÁé©Ê∏∏Êàè<br><small>'+ (getUILangObj().importPlay || 'Import & Play') +'</small>';
    }

    // ===== Tips feature =====
    // v15: Refresh UI after language button click and on load
    document.addEventListener('click', function(e){
      const t = e.target;
      if(t && t.classList && t.classList.contains('lang-btn')){
        setTimeout(()=>{ if(typeof refreshUITexts==='function') refreshUITexts(); }, 0);
      }
    });
    window.addEventListener('load', function(){
      setTimeout(()=>{ if(typeof refreshUITexts==='function') refreshUITexts(); }, 0);
    });
    
    let tipsLeft = 4;
    function doTip(){
      if(tipsLeft<=0){ showToast('Â∑≤Êó†ÂèØÁî®ÊèêÁ§∫ / ' + getUILangObj().tips + ' 0'); return; }
      // Find an unmatched id (present in all three columns)
      const ids = new Set(state.tiles.cn.map(t=>t.id));
      const id = Array.from(ids)[Math.floor(Math.random()*ids.size)];
      const w = state.usingTrial ? state.trialWords[id] : demoData[id];
      if(!w) return;
      const cn = state.usingTrial ? w.cn : w[0];
      const py = state.usingTrial ? w.py : w[1];
      const tr = state.usingTrial ? (w.langs[state.langIdx]||w.langs[0]) : w[2][state.langIdx];
      // highlight
      ['cn','py','tr'].forEach(k=>{
        const node = document.querySelector('.tile[data-kind="${k}"][data-id="${id}"]');
        if(node){
          node.style.boxShadow = '0 0 0 3px var(--tileC), 0 0 22px rgba(0,0,0,.25)';
          node.style.filter = 'saturate(1.2)';
          setTimeout(()=>{ node.style.boxShadow=''; node.style.filter=''; }, 1200);
        }
      });
      const L = getUILangObj();
      showToast('ÊèêÁ§∫Ôºö‚Äò${cn} ‚Äì ${py} ‚Äì ${tr}‚Äô ÊòØ‰∏ÄÁªÑÊ≠£Á°ÆÈÖçÂØπ„ÄÇ / ' + (L.hintText(cn,py,tr)), 'info');
      tipsLeft--;
    }

    document.getElementById('btnTip').addEventListener('click', ()=>{ playSfx('click'); doTip(); });

    // Hook language changes to update UI texts (guarded)
if (typeof buildLangRow === 'function') {
  const __oldBuildLangRow = buildLangRow;
  buildLangRow = function(){
    __oldBuildLangRow();
    refreshUITexts();
  };
}


    // Ensure texts are set at init and after level changes (guarded)
if (typeof renderBoard === 'function') {
  const __oldRenderBoard = renderBoard;
  renderBoard = function(){
    __oldRenderBoard();
    refreshUITexts();
    tipsLeft = 4; // reset tips per round
  };
}


    
    
    // ===== Demo end message (after level 4) =====
    (function(){
      function attachDemoEndOverride(){
        if (typeof makeRoundBuiltin !== 'function') return false;
        const __oldMakeRoundBuiltin = makeRoundBuiltin;
        makeRoundBuiltin = function(){
          const N = 5, MAX_LEVELS = 4;
          if(state.level>MAX_LEVELS){
            renderBoardEmpty && renderBoardEmpty();
            const L = getUILangObj ? getUILangObj() : {};
            // Bilingual end text with congrats
            const msg = 'ËØïÁé©ÁªìÊùü / ' + (L.demoOverTitle || 'Demo Completed') + ' ‚Äî ' +
                        (L.demoOverBody || 'If you want to continue, please go to ‚ÄúImport & Play‚Äù.');
            const congrats = (L.congrats || 'Congratulations on completing the demo!');
            updateOverlay && updateOverlay(true, congrats + '  ' + msg);
            const f = document.getElementById('finish');
            if(!f) return;
            const prevBtn = document.getElementById('btnPrev');
            const nextBtn = document.getElementById('btnNext');
            if(prevBtn) prevBtn.style.display = 'none';
            if(nextBtn) nextBtn.style.display = 'none';
            // Back to menu (bilingual)
            if(!document.getElementById('btnToMenu')){
              const btn = document.createElement('button');
              btn.className = 'btn'; btn.id = 'btnToMenu';
              btn.textContent = 'ËøîÂõû‰∏ªËèúÂçï / ' + ((L.backMenu)||'Back to Menu');
              btn.addEventListener('click', ()=>{
                document.getElementById('gameDemo').style.display='none';
                document.getElementById('stage').style.display='block';
                updateOverlay && updateOverlay(false);
              });
              f.appendChild(btn);
            }
            // Replay (bilingual)
            if(!document.getElementById('btnReplay')){
              const rbtn = document.createElement('button');
              rbtn.className = 'btn'; rbtn.id = 'btnReplay';
              rbtn.textContent = 'ÈáçÊñ∞ËØïÁé© / ' + ((L.replay)||'Replay');
              rbtn.addEventListener('click', ()=>{
                document.getElementById('gameDemo').style.display='block';
                document.getElementById('stage').style.display='none';
                state.level = 1;
                state.passed = 0;
                tipsLeft = 4;
                updateOverlay && updateOverlay(false);
                __oldMakeRoundBuiltin();
              });
              f.appendChild(rbtn);
            }
            return;
          }
          __oldMakeRoundBuiltin();
        };
        return true;
      }
      if(!attachDemoEndOverride()){
        window.addEventListener('load', attachDemoEndOverride);
      }
    })();

    makeRoundBuiltin = function(){
      const N = 5, MAX_LEVELS = 4;
      if(state.level>MAX_LEVELS){
        renderBoardEmpty();
        const L = getUILangObj();
        // Bilingual end text
        updateOverlay(true, 'ËØïÁé©ÁªìÊùü / ' + (L.demoOverTitle || 'Demo Completed') + ' ‚Äî ' + (L.demoOverBody || 'If you want to continue, please go to ‚ÄúImport & Play‚Äù.'));
        const f = document.getElementById('finish');
        const prevBtn = document.getElementById('btnPrev');
        const nextBtn = document.getElementById('btnNext');
        if(prevBtn) prevBtn.style.display = 'none';
        if(nextBtn) nextBtn.style.display = 'none';
        // Back to menu (bilingual)
        if(!document.getElementById('btnToMenu')){
          const btn = document.createElement('button');
          btn.className = 'btn'; btn.id = 'btnToMenu';
          btn.textContent = 'ËøîÂõû‰∏ªËèúÂçï / ' + ((L.backMenu)||'Back to Menu');
          btn.addEventListener('click', ()=>{
            document.getElementById('gameDemo').style.display='none';
            document.getElementById('stage').style.display='block';
            updateOverlay(false);
          });
          f.appendChild(btn);
        }
        // Replay (bilingual title)
        if(!document.getElementById('btnReplay')){
          const rbtn = document.createElement('button');
          rbtn.className = 'btn'; rbtn.id = 'btnReplay';
          rbtn.textContent = 'ÈáçÊñ∞ËØïÁé© / ' + ((L.replay)||'Replay');
          rbtn.addEventListener('click', ()=>{
            document.getElementById('gameDemo').style.display='block';
            document.getElementById('stage').style.display='none';
            state.level = 1;
            state.passed = 0;
            tipsLeft = 4;
            updateOverlay(false);
            __oldMakeRoundBuiltin();
          });
          f.appendChild(rbtn);
        }
        return;
      }
      __oldMakeRoundBuiltin();
    };
  
// ===== v17: Global bilingual UI (Chinese / English) =====
(function(){
  function setText(id, zh, en){
    var el = document.getElementById(id);
    if(el){ el.textContent = zh + ' / ' + en; }
  }
  function applyBilingualUI(){
    // Top bars & buttons
    setText('btnBackTop','ËøîÂõû‰∏ªËèúÂçï','Back to Menu');
    setText('btnTip','ÊèêÁ§∫','Tips');
    setText('btnShuffle','ÈáçÊéíÂ∫è','Reshuffle');
    setText('btnSave','‰øùÂ≠ò','Save');
    setText('btnBack','ËøîÂõû‰∏ä‰∏ÄÁ∫ß','Back');
    setText('btnWrong','ÈîôËØçÊú¨','Wrong Book');

    // Stage actions
    var actDemo = document.getElementById('actDemo'); if(actDemo) actDemo.innerHTML = 'ËØïÁé©Ê∏∏Êàè / Demo<br><small>ÂÜÖÁΩÆ 20 ‰∏™ / Built-in 20</small>';
    var actImport = document.getElementById('actImport'); if(actImport) actImport.innerHTML = 'ÂØºÂÖ•ËØçÂ∫ìÁé©Ê∏∏Êàè / Import & Play<br><small>ÈÄâÊã©Êñá‰ª∂ / Choose a file</small>';

    // Progress labels (keep numbers)
    var levelInfo = document.getElementById('levelInfo');
    if(levelInfo){ levelInfo.innerHTML = 'ÂÖ≥Âç°Ôºö<strong>'+ (window.state && state.level || 1) +'</strong> / Level <strong>'+ (window.state && state.level || 1) +'</strong>'; }
    var prog = document.querySelector('.progress');
    if(prog){
      var passed = document.getElementById('passed') ? document.getElementById('passed').textContent : '0';
      var total = document.getElementById('total') ? document.getElementById('total').textContent : '0';
      prog.innerHTML = 'ËøõÂ∫¶ <span id=\"passed\">'+passed+'</span>/<span id=\"total\">'+total+'</span> / Progress <span>'+passed+'</span>/<span>'+total+'</span>';
    }

    // Jump row
    var jumpGo = document.getElementById('jumpGo'); if(jumpGo) jumpGo.textContent = 'Go';
  }
  window.applyBilingualUI = applyBilingualUI;
  window.addEventListener('load', function(){ setTimeout(applyBilingualUI, 0); });
  document.addEventListener('click', function(e){
    var t = e.target;
    if(t && t.classList && t.classList.contains('lang-btn')){
      setTimeout(applyBilingualUI, 0);
    }
  });
})();

// ===== v17: End-of-demo overlay with Replay & Back (bilingual) =====
(function(){
  function attach(){
    if(typeof makeRoundBuiltin !== 'function') return false;
    var __old = makeRoundBuiltin;
    makeRoundBuiltin = function(){
      var N = 5, MAX_LEVELS = 4;
      if(window.state && state.level>MAX_LEVELS){
        if(typeof renderBoardEmpty==='function') renderBoardEmpty();
        if(typeof updateOverlay==='function') updateOverlay(true, 'ÊÅ≠ÂñúÂÆåÊàêËØïÁé©ÔºÅ / Congratulations on completing the demo!  ËØïÁé©ÁªìÊùü / Demo Completed ‚Äî Ëã•ÊÉ≥ÁªßÁª≠ÔºåËØ∑ÂâçÂæÄ‚ÄúÂØºÂÖ•ËØçÂ∫ìÁé©Ê∏∏Êàè‚Äù / If you want to continue, please go to ‚ÄúImport & Play‚Äù.');
        var f = document.getElementById('finish'); if(!f) return;
        var prevBtn = document.getElementById('btnPrev'); if(prevBtn) prevBtn.style.display='none';
        var nextBtn = document.getElementById('btnNext'); if(nextBtn) nextBtn.style.display='none';
        // Back to Menu
        if(!document.getElementById('btnToMenu')){
          var backBtn = document.createElement('button');
          backBtn.className = 'btn'; backBtn.id = 'btnToMenu';
          backBtn.textContent = 'ËøîÂõû‰∏ªËèúÂçï / Back to Menu';
          backBtn.onclick = function(){
            document.getElementById('gameDemo').style.display='none';
            document.getElementById('stage').style.display='block';
            if(typeof updateOverlay==='function') updateOverlay(false);
          };
          f.appendChild(backBtn);
        }
        // Replay
        if(!document.getElementById('btnReplay')){
          var rbtn = document.createElement('button');
          rbtn.className = 'btn'; rbtn.id = 'btnReplay';
          rbtn.textContent = 'ÈáçÊñ∞ËØïÁé© / Replay Demo';
          rbtn.onclick = function(){
            document.getElementById('gameDemo').style.display='block';
            document.getElementById('stage').style.display='none';
            if(window.state){ state.level=1; state.passed=0; }
            if(typeof updateOverlay==='function') updateOverlay(false);
            if(typeof __old==='function') __old();
            if(typeof window.applyBilingualUI==='function') setTimeout(window.applyBilingualUI, 0);
          };
          f.appendChild(rbtn);
        }
        return;
      }
      if(typeof __old==='function') __old();
    };
    return true;
  }
  if(!attach()){ window.addEventListener('load', attach); }
})();

// ===== v17: Tips localization to bilingual (CN/EN) & count per round reset =====
(function(){
  function tipInfoText(cn,py,tr){
    return 'ÊèêÁ§∫Ôºö' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + ' ÊòØ‰∏ÄÁªÑÊ≠£Á°ÆÈÖçÂØπ„ÄÇ / Hint: ‚Äú' + cn + ' ‚Äì ' + py + ' ‚Äì ' + tr + '‚Äù is a correct match.';
  }
  var oldOnTip = document.getElementById('btnTip') && document.getElementById('btnTip').onclick;
  // Keep existing click listener but we also set a global handler to reset tipsLeft each render if renderBoard exists
  var binder = function(){
    var btn = document.getElementById('btnTip');
    if(!btn) return;
    btn.addEventListener('click', function(){ setTimeout(function(){ if(typeof window.applyBilingualUI==='function') window.applyBilingualUI(); }, 0); });
  };
  window.addEventListener('load', binder);
  // Reset tipsLeft on renderBoard if available
  if(typeof renderBoard==='function'){
    var __rb = renderBoard;
    renderBoard = function(){
      __rb();
      try{ tipsLeft = 4; }catch(e){}
      if(typeof window.applyBilingualUI==='function') window.applyBilingualUI();
    };
  } else {
    window.addEventListener('load', function(){
      try{ tipsLeft = 4; }catch(e){}
    });
  }
})();

</script>
</body>
</html>